<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CJT體重增加費用分攤計算器</title>
    <!-- 添加PDF导出所需的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #4682B4;
            --secondary-color: #9370DB; /* 紫色用于第二个表格 */
            --yellow: #FFFD9A;  /* 更柔和的黄色 */
            --light-blue: #B8E2F2;  /* 更鲜明的蓝色 */
            --orange: #FFC87C;  /* 更柔和的橙色 */
            --green: #A5E1AD;  /* 更鲜明的绿色 */
            --border-color: #ddd;
            --header-bg: #f7f7f7;
            --button-hover: #3A6B99;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            
            /* 定义多个订单颜色 */
            --order1-color: #4682B4; /* 蓝色 - 原primary-color */
            --order1-color-light: #d1e6f9; /* 蓝色浅色背景 */
            --order1-color-dark: #2C5D8F; /* 蓝色深色渐变 */
            
            --order2-color: #9370DB; /* 紫色 - 原secondary-color */
            --order2-color-light: #e9e0fa; /* 紫色浅色背景 */
            --order2-color-dark: #7D5CC1; /* 紫色深色渐变 */
            
            --order3-color: #e67e22; /* 橙色 */
            --order3-color-light: #fae7d6; /* 橙色浅色背景 */
            --order3-color-dark: #d35400; /* 橙色深色渐变 */
            
            --order4-color: #16a085; /* 绿松石色 */
            --order4-color-light: #d1f2eb; /* 绿松石浅色背景 */
            --order4-color-dark: #0e6251; /* 绿松石深色渐变 */
            
            --order5-color: #c0392b; /* 红色 */
            --order5-color-light: #f2d7d5; /* 红色浅色背景 */
            --order5-color-dark: #962d22; /* 红色深色渐变 */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding-bottom: 60px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #2C5D8F);
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        
        h1 {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .toolbar {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
            padding: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 20px;
        }
        
        button {
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-width: 150px;
        }
        
        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #addOrderBtn, #calculateBtn {
            background: linear-gradient(135deg, #5a92c6, var(--primary-color));
        }
        
        #clearAllBtn {
            background: linear-gradient(135deg, #f5716c, #e74c3c);
            font-weight: bold;
        }
        
        #clearAllBtn:hover {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .calculator-section {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }
        
        .calculator-section:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .section-header {
            background: linear-gradient(135deg, var(--order1-color), var(--order1-color-dark));
            color: white;
            padding: 12px 18px;
            font-weight: bold;
            font-size: 16px;
            letter-spacing: 0.5px;
        }
        
        .section-header.secondary {
            background: linear-gradient(135deg, var(--secondary-color), #7D5CC1);
        }
        
        .table-container {
            overflow-x: auto;
            padding: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
            transition: background-color 0.2s;
        }
        
        th {
            background-color: var(--header-bg);
            position: sticky;
            top: 0;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        tr:hover td {
            background-color: #f9f9f9;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            transition: border 0.2s;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(70, 130, 180, 0.2);
        }
        
        .yellow-bg {
            background-color: var(--yellow);
        }
        
        .light-blue-bg {
            background-color: var(--light-blue);
        }
        
        .orange-bg {
            background-color: var(--orange);
        }
        
        .green-bg {
            background-color: var(--green);
        }
        
        .total-row {
            font-weight: bold;
            background-color: #e9f5ff;
        }
        
        .red-text {
            color: #e74c3c;
        }
        
        .item-row td {
            vertical-align: middle;
        }
        
        .add-row {
            margin: 15px 0;
            text-align: center;
        }
        
        .summary-section {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            flex: 1;
            min-width: 250px;
            transition: all 0.3s ease;
        }
        
        .summary-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .summary-title {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
        }
        
        .summary-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .summary-label {
            font-weight: bold;
            color: #555;
        }
        
        .order-container {
            margin-bottom: 30px;
        }
        
        .order-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        
        .order-tab {
            padding: 10px 20px;
            background-color: #eee;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 500;
            border: 1px solid #ddd;
            border-bottom: none;
            transition: all 0.2s;
            position: relative; /* 为删除按钮定位 */
        }
        
        .order-tab:hover {
            background-color: #e0e0e0;
        }
        
        .order-tab.active {
            background: linear-gradient(to bottom, var(--order1-color), var(--order1-color-dark));
            color: white;
            border-color: var(--order1-color);
        }
        
        .order-tab.secondary.active {
            background: linear-gradient(to bottom, var(--secondary-color), #7D5CC1);
            border-color: var(--secondary-color);
        }
        
        #addOrderTabBtn {
            width: 30px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 8px 8px 0 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .order-tab-content {
            display: none;
        }
        
        .order-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .final-summary {
            background: linear-gradient(135deg, #5cb85c, #449d44);
        }
        
        #finalSummaryTable {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        #finalSummaryTable th, #finalSummaryTable td {
            border: 1px solid #ddd;
        }
        
        #finalSummaryTable th {
            background-color: #f2f9f2;
            color: #2c7c2c;
        }
        
        #finalSummaryTable tr:last-child td {
            font-weight: bold;
            background-color: #f0fff0;
        }
        
        @media (max-width: 768px) {
            .summary-section {
                flex-direction: column;
            }
            
            .toolbar {
                flex-direction: column;
            }
            
            .button-group {
                width: 100%;
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .order-tab {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 10px;
            text-align: center;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        /* Additional styling for the remove buttons */
        .remove-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff4d4d);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .remove-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff3333);
            transform: scale(1.1);
        }
        
        /* 添加PDF导出相关样式 */
        #exportPdfBtn {
            background: linear-gradient(135deg, #6e5baa, #4a387d);
            font-weight: bold;
        }
        
        #exportPdfBtn:hover {
            background: linear-gradient(135deg, #5a4a8c, #3c2c69);
        }
        
        .export-options {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            width: 350px;
        }
        
        .export-options h3 {
            margin-top: 0;
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .export-option {
            margin-bottom: 15px;
        }
        
        .export-option label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .export-options .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            text-align: center;
        }
        
        .loading-indicator p {
            margin: 5px 0;
            font-size: 16px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 添加删除订单按钮的样式 */
        .order-delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .order-tab:hover .order-delete-btn {
            opacity: 1;
        }
        
        .order-delete-btn:hover {
            transform: scale(1.1);
            background-color: #c0392b;
        }
        
        /* 删除确认对话框样式 */
        .delete-confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            width: 350px;
            text-align: center;
        }
        
        .delete-confirm-dialog h3 {
            margin-top: 0;
            color: #e74c3c;
            margin-bottom: 15px;
        }
        
        .delete-confirm-dialog p {
            margin-bottom: 20px;
            color: #555;
        }
        
        .delete-confirm-dialog .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .delete-confirm-dialog .cancel-btn {
            background-color: #95a5a6;
        }
        
        .delete-confirm-dialog .confirm-btn {
            background-color: #e74c3c;
        }
        
        .delete-confirm-dialog .cancel-btn:hover {
            background-color: #7f8c8d;
        }
        
        .delete-confirm-dialog .confirm-btn:hover {
            background-color: #c0392b;
        }
        
        /* 修改总结算表样式，使订单区分更明显 */
        #finalSummaryTable th.order-column[data-order-id="1"],
        #finalSummaryTable td.order-column[data-order-id="1"] {
            background-color: var(--order1-color-light);
            border-left: 2px solid var(--order1-color);
        }
        
        #finalSummaryTable th.order-column[data-order-id="2"],
        #finalSummaryTable td.order-column[data-order-id="2"] {
            background-color: var(--order2-color-light);
            border-left: 2px solid var(--order2-color);
        }
        
        #finalSummaryTable th.order-column[data-order-id="3"],
        #finalSummaryTable td.order-column[data-order-id="3"] {
            background-color: var(--order3-color-light);
            border-left: 2px solid var(--order3-color);
        }
        
        #finalSummaryTable th.order-column[data-order-id="4"],
        #finalSummaryTable td.order-column[data-order-id="4"] {
            background-color: var(--order4-color-light);
            border-left: 2px solid var(--order4-color);
        }
        
        #finalSummaryTable th.order-column[data-order-id="5"],
        #finalSummaryTable td.order-column[data-order-id="5"] {
            background-color: var(--order5-color-light);
            border-left: 2px solid var(--order5-color);
        }
        
        #finalSummaryTable .order-group-header {
            text-align: center;
            background: linear-gradient(135deg, #e8f4f8, #d1e7f0);
            font-weight: bold;
            border-bottom: 1px solid #bbd8e7;
        }
        
        #finalSummaryTable .total-row td.order-column {
            font-weight: bold;
            color: #333;
        }
        
        #finalSummaryTable .grand-total-column {
            background-color: #e9f7e9;
            border-left: 2px solid #5cb85c;
            font-weight: bold;
        }
        
        #finalSummaryTable th.grand-total-column {
            background-color: #d0e9d0;
        }
        
        /* 为不同序号的订单设置不同的颜色 */
        .order-tab[data-order-id="1"].active,
        .order-tab-content[data-order-id="1"] .section-header {
            background: linear-gradient(to bottom, var(--order1-color), var(--order1-color-dark));
            border-color: var(--order1-color);
        }
        
        .order-tab[data-order-id="2"].active,
        .order-tab-content[data-order-id="2"] .section-header {
            background: linear-gradient(to bottom, var(--order2-color), var(--order2-color-dark));
            border-color: var(--order2-color);
        }
        
        .order-tab[data-order-id="3"].active,
        .order-tab-content[data-order-id="3"] .section-header {
            background: linear-gradient(to bottom, var(--order3-color), var(--order3-color-dark));
            border-color: var(--order3-color);
        }
        
        .order-tab[data-order-id="4"].active,
        .order-tab-content[data-order-id="4"] .section-header {
            background: linear-gradient(to bottom, var(--order4-color), var(--order4-color-dark));
            border-color: var(--order4-color);
        }
        
        .order-tab[data-order-id="5"].active,
        .order-tab-content[data-order-id="5"] .section-header {
            background: linear-gradient(to bottom, var(--order5-color), var(--order5-color-dark));
            border-color: var(--order5-color);
        }
        
        /* 非激活标签也有对应颜色但较淡 */
        .order-tab[data-order-id="1"] {
            border-top: 3px solid var(--order1-color);
            color: var(--order1-color);
        }
        
        .order-tab[data-order-id="2"] {
            border-top: 3px solid var(--order2-color);
            color: var(--order2-color);
        }
        
        .order-tab[data-order-id="3"] {
            border-top: 3px solid var(--order3-color);
            color: var(--order3-color);
        }
        
        .order-tab[data-order-id="4"] {
            border-top: 3px solid var(--order4-color);
            color: var(--order4-color);
        }
        
        .order-tab[data-order-id="5"] {
            border-top: 3px solid var(--order5-color);
            color: var(--order5-color);
        }
        
        .order-tab[data-order-id="1"]:hover {
            background-color: var(--order1-color-light);
        }
        
        .order-tab[data-order-id="2"]:hover {
            background-color: var(--order2-color-light);
        }
        
        .order-tab[data-order-id="3"]:hover {
            background-color: var(--order3-color-light);
        }
        
        .order-tab[data-order-id="4"]:hover {
            background-color: var(--order4-color-light);
        }
        
        .order-tab[data-order-id="5"]:hover {
            background-color: var(--order5-color-light);
        }
    </style>
</head>
<body>
    <header>
        <h1>CJT體重增加費用分攤計算器</h1>
    </header>
    
    <div class="container">
        <div class="toolbar">
            <div class="button-group">
                <button id="clearAllBtn">清除所有數據</button>
            </div>
            <div class="button-group">
                <button id="exportPdfBtn">匯出PDF</button>
            </div>
        </div>
        
        <div class="summary-section">
            <div class="summary-card">
                <div class="summary-title">訂單摘要</div>
                <div class="summary-items">
                    <div class="summary-item">
                        <div class="summary-label">總毛額:</div>
                        <div id="summaryGross">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">總優惠:</div>
                        <div id="summaryDiscount" class="red-text">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">總淨額:</div>
                        <div id="summaryNet">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">人數:</div>
                        <div id="summaryPeople">0</div>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-title">費用明細</div>
                <div class="summary-items">
                    <div class="summary-item">
                        <div class="summary-label">餐點總額:</div>
                        <div id="summaryFood">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">外賣盒費:</div>
                        <div id="summaryBox">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">配送費:</div>
                        <div id="summaryDelivery">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">膠袋費:</div>
                        <div id="summaryBag">0.00</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 订单选项卡 -->
        <div class="order-tabs" id="orderTabs">
            <div class="order-tab active" data-order-id="1">訂單 1</div>
            <button id="addOrderTabBtn">+</button>
        </div>
        
        <!-- 订单内容 -->
        <div id="orderContents">
            <!-- 订单1 -->
            <div class="order-tab-content active" data-order-id="1">
        <div class="calculator-section">
                    <div class="section-header">餐點明細及分攤 - 訂單 1</div>
            <div class="table-container">
                        <table class="meal-table" id="mealTable1">
                    <thead>
                        <tr>
                            <th width="5%">序號</th>
                            <th width="10%">飯友</th>
                            <th class="yellow-bg" width="10%">毛付</th>
                            <th class="yellow-bg" width="10%">外賣盒</th>
                            <th class="yellow-bg" width="10%">配送費</th>
                            <th class="light-blue-bg" width="10%">商家優惠</th>
                            <th class="light-blue-bg" width="10%">膠袋費</th>
                            <th class="orange-bg" width="10%">比例</th>
                            <th width="10%">淨付</th>
                            <th width="5%">操作</th>
                        </tr>
                    </thead>
                            <tbody class="meal-table-body" id="mealTableBody1">
                        <!-- Default first row -->
                        <tr class="item-row" data-row-id="1">
                            <td>01</td>
                            <td><input type="text" class="person-name" value=""></td>
                            <td class="yellow-bg"><input type="number" step="0.01" class="meal-cost" value="0"></td>
                            <td class="yellow-bg"><input type="number" step="0.01" class="box-fee" value="0"></td>
                                    <td class="yellow-bg"><input type="number" step="0.01" class="delivery-fee" value="0" readonly></td>
                                    <td class="light-blue-bg"><input type="number" step="0.01" class="discount" value="0" readonly></td>
                                    <td class="light-blue-bg"><input type="number" step="0.01" class="bag-fee" value="0" readonly></td>
                            <td class="orange-bg percentage">0%</td>
                            <td class="net-pay">0.00</td>
                            <td><span class="remove-btn">×</span></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="2">總計</td>
                                    <td class="yellow-bg total-gross">0.00</td>
                                    <td class="yellow-bg total-box">0.00</td>
                                    <td class="yellow-bg total-delivery">0.00</td>
                                    <td class="light-blue-bg red-text total-discount">0.00</td>
                                    <td class="light-blue-bg total-bag">0.00</td>
                                    <td class="orange-bg total-percentage">0%</td>
                                    <td class="total-net">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="add-row">
                        <button class="add-row-btn" data-order-id="1">新增一行</button>
            </div>
        </div>
        
        <div class="calculator-section">
                    <div class="section-header">其他支出明細 - 訂單 1</div>
            <div class="table-container">
                        <table class="expense-table" id="expenseTable1">
                    <thead>
                        <tr>
                            <th width="30%">項目</th>
                            <th width="20%">金額</th>
                            <th width="30%">備註</th>
                            <th width="20%">操作</th>
                        </tr>
                    </thead>
                            <tbody class="expense-table-body" id="expenseTableBody1">
                        <tr class="expense-row">
                                    <td>配送費</td>
                                    <td><input type="number" step="0.01" class="expense-amount delivery-fee-total" value="0"></td>
                                    <td><input type="text" class="expense-note" value="配送費用"></td>
                            <td></td>
                        </tr>
                        <tr class="expense-row">
                                    <td>商家優惠</td>
                                    <td><input type="number" step="0.01" class="expense-amount merchant-discount" value="0"></td>
                                    <td><input type="text" class="expense-note" value="由商家提供的折扣"></td>
                            <td></td>
                        </tr>
                        <tr class="expense-row">
                                    <td>膠袋費</td>
                                    <td><input type="number" step="0.01" class="expense-amount bag-fee-total" value="0"></td>
                            <td><input type="text" class="expense-note" value="環保膠袋費用"></td>
                            <td></td>
                        </tr>
                    </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 修改总结算表结构 -->
        <div class="calculator-section">
            <div class="section-header final-summary">總結算表</div>
            <div class="table-container">
                <table id="finalSummaryTable">
                    <thead>
                        <tr>
                            <th rowspan="2" width="5%">序號</th>
                            <th rowspan="2" width="10%">飯友</th>
                            <th colspan="7" class="order-group-header">每人消費明細</th>
                            <th rowspan="2" class="grand-total-column" width="8%">合計</th>
                        </tr>
                        <tr>
                            <th class="yellow-bg" width="9%">餐費</th>
                            <th class="yellow-bg" width="9%">外賣盒</th>
                            <th class="yellow-bg" width="9%">配送費</th>
                            <th class="light-blue-bg" width="9%">商家優惠</th>
                            <th class="light-blue-bg" width="9%">膠袋費</th>
                            <th class="orange-bg" width="9%">比例</th>
                            <th width="9%">淨付</th>
                        </tr>
                    </thead>
                    <tbody id="finalSummaryTableBody">
                        <!-- 将在 JavaScript 中动态生成 -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="2">總計</td>
                            <td id="finalTotalGross">0.00</td>
                            <td id="finalTotalBox">0.00</td>
                            <td id="finalTotalDelivery">0.00</td>
                            <td id="finalTotalDiscount">0.00</td>
                            <td id="finalTotalBag">0.00</td>
                            <td id="finalTotalPercentage">0%</td>
                            <td id="finalTotalNet">0.00</td>
                            <td id="grandTotal" class="grand-total-column">0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <div class="footer">
        CJT體重增加費用分攤計算器 © 2025
    </div>
    
    <!-- 添加PDF导出选项对话框 -->
    <div class="overlay" id="overlay"></div>

    <div class="export-options" id="exportOptions">
        <h3>匯出PDF選項</h3>
        <div class="export-option">
            <label for="exportContent">匯出內容：</label>
            <select id="exportContent" class="export-select">
                <option value="all">所有內容</option>
                <option value="current">當前訂單</option>
                <option value="summary">僅總結算表</option>
            </select>
        </div>
        <div class="export-option">
            <label for="pageSize">紙張大小：</label>
            <select id="pageSize" class="export-select">
                <option value="a4">A4</option>
                <option value="letter">Letter</option>
                <option value="legal">Legal</option>
            </select>
        </div>
        <div class="export-option">
            <label for="orientation">方向：</label>
            <select id="orientation" class="export-select">
                <option value="portrait">縱向</option>
                <option value="landscape">橫向</option>
            </select>
        </div>
        <div class="export-option">
            <label for="exportFilename">檔案名稱：</label>
            <input type="text" id="exportFilename" value="費用分攤計算-" class="export-select">
        </div>
        <div class="buttons">
            <button id="cancelExportBtn">取消</button>
            <button id="confirmExportBtn">匯出</button>
        </div>
    </div>

    <div class="loading-indicator" id="loadingIndicator">
        <div class="spinner"></div>
        <p>正在生成PDF，請稍候...</p>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize global variables
            let orderCounter = 1;
            let rowCounters = { 1: 1 };
            let activeOrderId = 1;
            
            // Set up event handlers
            document.querySelector('.add-row-btn[data-order-id="1"]').addEventListener('click', function() {
                addNewRow(1);
            });
            
            // 保留添加订单按钮在选项卡区域
            document.getElementById('addOrderTabBtn').addEventListener('click', addNewOrder);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);
            
            // Setup tab switching
            setupTabs();
            
            // Setup remove buttons
            setupRemoveButtons();
            
            // Setup input change handlers for automatic calculation
            setupInputHandlers();
            
            // Add some sample data
            addSampleData();
            
            // Calculate initially
            calculateAll();
            updateFinalSummary();
            
            // 添加PDF导出相关功能
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const overlay = document.getElementById('overlay');
            const exportOptions = document.getElementById('exportOptions');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const confirmExportBtn = document.getElementById('confirmExportBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // 设置默认文件名为当前日期
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            document.getElementById('exportFilename').value = `費用分攤計算-${dateStr}`;
            
            // 显示导出选项对话框
            exportPdfBtn.addEventListener('click', function() {
                overlay.style.display = 'block';
                exportOptions.style.display = 'block';
            });
            
            // 取消导出
            cancelExportBtn.addEventListener('click', function() {
                overlay.style.display = 'none';
                exportOptions.style.display = 'none';
            });
            
            // 确认导出
            confirmExportBtn.addEventListener('click', function() {
                // 隐藏选项对话框
                exportOptions.style.display = 'none';
                
                // 显示加载指示器
                loadingIndicator.style.display = 'block';
                
                // 获取导出选项
                const exportContent = document.getElementById('exportContent').value;
                const pageSize = document.getElementById('pageSize').value;
                const orientation = document.getElementById('orientation').value;
                const filename = document.getElementById('exportFilename').value + '.pdf';
                
                // 在短暂延迟后开始导出（让UI有时间更新）
                setTimeout(function() {
                    generatePDF(exportContent, pageSize, orientation, filename);
                }, 100);
            });
            
            function setupTabs() {
                document.getElementById('orderTabs').addEventListener('click', function(e) {
                    // 如果点击的是删除按钮，则不切换标签
                    if (e.target.classList.contains('order-delete-btn')) {
                        return;
                    }
                    
                    if (e.target.classList.contains('order-tab')) {
                        const orderId = e.target.dataset.orderId;
                        switchTab(orderId);
                    }
                });
            }
            
            function switchTab(orderId) {
                // Hide all tabs and contents
                document.querySelectorAll('.order-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.order-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Show selected tab and content
                document.querySelector(`.order-tab[data-order-id="${orderId}"]`).classList.add('active');
                document.querySelector(`.order-tab-content[data-order-id="${orderId}"]`).classList.add('active');
                
                // Update active order
                activeOrderId = orderId;
            }
            
            function addNewOrder() {
                orderCounter++;
                const newOrderId = orderCounter;
                rowCounters[newOrderId] = 1;
                
                // Add new tab
                const orderTabs = document.getElementById('orderTabs');
                const newTab = document.createElement('div');
                newTab.className = 'order-tab';
                newTab.dataset.orderId = newOrderId;
                newTab.textContent = `訂單 ${newOrderId}`;
                
                // 添加删除按钮，但不为订单1添加
                if (newOrderId > 1) {
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'order-delete-btn';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.setAttribute('title', '刪除此訂單');
                    deleteBtn.dataset.orderId = newOrderId;
                    
                    // 添加删除事件
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // 阻止事件冒泡，防止触发标签切换
                        showDeleteOrderConfirm(newOrderId);
                    });
                    
                    newTab.appendChild(deleteBtn);
                }
                
                orderTabs.insertBefore(newTab, document.getElementById('addOrderTabBtn'));
                
                // Add new content
                const orderContents = document.getElementById('orderContents');
                const newContent = document.createElement('div');
                newContent.className = 'order-tab-content';
                newContent.dataset.orderId = newOrderId;
                
                // Create content for the new order
                // 不再使用 headerClass 来区分，让 CSS 基于 data-order-id 属性设置颜色
                const headerClass = 'section-header';
                
                newContent.innerHTML = `
                    <div class="calculator-section">
                        <div class="${headerClass}">餐點明細及分攤 - 訂單 ${newOrderId}</div>
                        <div class="table-container">
                            <table class="meal-table" id="mealTable${newOrderId}">
                                <thead>
                                    <tr>
                                        <th width="5%">序號</th>
                                        <th width="10%">飯友</th>
                                        <th class="yellow-bg" width="10%">毛付</th>
                                        <th class="yellow-bg" width="10%">外賣盒</th>
                                        <th class="yellow-bg" width="10%">配送費</th>
                                        <th class="light-blue-bg" width="10%">商家優惠</th>
                                        <th class="light-blue-bg" width="10%">膠袋費</th>
                                        <th class="orange-bg" width="10%">比例</th>
                                        <th width="10%">淨付</th>
                                        <th width="5%">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="meal-table-body" id="mealTableBody${newOrderId}">
                                    <tr class="item-row" data-row-id="1">
                                        <td>01</td>
                                        <td><input type="text" class="person-name" value=""></td>
                                        <td class="yellow-bg"><input type="number" step="0.01" class="meal-cost" value="0"></td>
                                        <td class="yellow-bg"><input type="number" step="0.01" class="box-fee" value="0"></td>
                                        <td class="yellow-bg"><input type="number" step="0.01" class="delivery-fee" value="0" readonly></td>
                                        <td class="light-blue-bg"><input type="number" step="0.01" class="discount" value="0" readonly></td>
                                        <td class="light-blue-bg"><input type="number" step="0.01" class="bag-fee" value="0" readonly></td>
                                        <td class="orange-bg percentage">0%</td>
                                        <td class="net-pay">0.00</td>
                                        <td><span class="remove-btn">×</span></td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td colspan="2">總計</td>
                                        <td class="yellow-bg total-gross">0.00</td>
                                        <td class="yellow-bg total-box">0.00</td>
                                        <td class="yellow-bg total-delivery">0.00</td>
                                        <td class="light-blue-bg red-text total-discount">0.00</td>
                                        <td class="light-blue-bg total-bag">0.00</td>
                                        <td class="orange-bg total-percentage">0%</td>
                                        <td class="total-net">0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="add-row">
                            <button class="add-row-btn" data-order-id="${newOrderId}">新增一行</button>
                        </div>
                    </div>
                    
                    <div class="calculator-section">
                        <div class="${headerClass}">其他支出明細 - 訂單 ${newOrderId}</div>
                        <div class="table-container">
                            <table class="expense-table" id="expenseTable${newOrderId}">
                                <thead>
                                    <tr>
                                        <th width="30%">項目</th>
                                        <th width="20%">金額</th>
                                        <th width="30%">備註</th>
                                        <th width="20%">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="expense-table-body" id="expenseTableBody${newOrderId}">
                                    <tr class="expense-row">
                                        <td>配送費</td>
                                        <td><input type="number" step="0.01" class="expense-amount delivery-fee-total" value="0"></td>
                                        <td><input type="text" class="expense-note" value="配送費用"></td>
                                        <td></td>
                                    </tr>
                                    <tr class="expense-row">
                                        <td>商家優惠</td>
                                        <td><input type="number" step="0.01" class="expense-amount merchant-discount" value="0"></td>
                                        <td><input type="text" class="expense-note" value="由商家提供的折扣"></td>
                                        <td></td>
                                    </tr>
                                    <tr class="expense-row">
                                        <td>膠袋費</td>
                                        <td><input type="number" step="0.01" class="expense-amount bag-fee-total" value="0"></td>
                                        <td><input type="text" class="expense-note" value="環保膠袋費用"></td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                orderContents.appendChild(newContent);
                
                // Setup the new buttons and handlers
                document.querySelector(`.add-row-btn[data-order-id="${newOrderId}"]`).addEventListener('click', function() {
                    addNewRow(newOrderId);
                });
                
                // Switch to the new tab
                switchTab(newOrderId.toString());
                
                // Setup the new remove buttons
                setupRemoveButtons();
                
                // Setup input handlers for the new order
                setupInputHandlers();
                
                // Update headers in final summary table
                updateFinalSummaryHeaders();
                
                // 自动计算
                calculateAll();
                updateFinalSummary();
            }
            
            function updateFinalSummaryHeaders() {
                // 没有必要动态调整表头，总结算表现在固定显示，不再根据订单数量变化
                // 该函数保留作为接口兼容，但不执行任何操作
            }
            
            function addNewRow(orderId) {
                rowCounters[orderId]++;
                const rowNum = rowCounters[orderId];
                const tbody = document.getElementById(`mealTableBody${orderId}`);
                const newRow = document.createElement('tr');
                newRow.className = 'item-row';
                newRow.dataset.rowId = rowNum;
                
                // Format row number with leading zero
                const displayRowNum = rowNum < 10 ? `0${rowNum}` : rowNum;
                
                newRow.innerHTML = `
                    <td>${displayRowNum}</td>
                    <td><input type="text" class="person-name" value=""></td>
                    <td class="yellow-bg"><input type="number" step="0.01" class="meal-cost" value="0"></td>
                    <td class="yellow-bg"><input type="number" step="0.01" class="box-fee" value="0"></td>
                    <td class="yellow-bg"><input type="number" step="0.01" class="delivery-fee" value="0" readonly></td>
                    <td class="light-blue-bg"><input type="number" step="0.01" class="discount" value="0" readonly></td>
                    <td class="light-blue-bg"><input type="number" step="0.01" class="bag-fee" value="0" readonly></td>
                    <td class="orange-bg percentage">0%</td>
                    <td class="net-pay">0.00</td>
                    <td><span class="remove-btn">×</span></td>
                `;
                
                tbody.appendChild(newRow);
                
                // Setup the new remove button
                setupRemoveButtons();
                
                // Setup input handlers for the new row
                setupInputHandlers();
                
                // 自动计算
                calculateOrderById(orderId);
                updateFinalSummary();
            }
            
            function setupRemoveButtons() {
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    // Remove any existing event listeners
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    // Add new event listener
                    newBtn.addEventListener('click', function() {
                        const row = this.closest('tr');
                        const table = this.closest('table');
                        const orderId = table.id.replace('mealTable', '');
                        
                        if (table.querySelectorAll('.item-row').length > 1) {
                            row.remove();
                            // 自动触发计算
                            calculateOrderById(orderId);
                            updateFinalSummary();
                        } else {
                            alert('必須至少保留一行');
                        }
                    });
                });
            }
            
            function setupInputHandlers() {
                // Remove any existing event listeners (by cloning and replacing)
                document.querySelectorAll('.meal-cost, .box-fee').forEach(input => {
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                });
                
                document.querySelectorAll('.delivery-fee-total, .merchant-discount, .bag-fee-total').forEach(input => {
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                });
                
                // Add new event listeners with automatic calculation
                document.querySelectorAll('.meal-cost, .box-fee').forEach(input => {
                    input.addEventListener('input', function() {
                        const table = this.closest('table');
                        const orderId = table.id.replace('mealTable', '');
                        calculateOrderById(orderId);
                        updateFinalSummary();
                    });
                });
                
                document.querySelectorAll('.delivery-fee-total, .merchant-discount, .bag-fee-total').forEach(input => {
                    input.addEventListener('input', function() {
                        const table = this.closest('table');
                        const orderId = table.id.replace('expenseTable', '');
                        calculateOrderById(orderId);
                        updateFinalSummary();
                    });
                });
                
                // 添加人员姓名输入变化时自动更新结算表
                document.querySelectorAll('.person-name').forEach(input => {
                    input.addEventListener('input', function() {
                        updateFinalSummary();
                    });
                });
            }
            
            function calculateAll() {
                // Calculate each order
                for (let i = 1; i <= orderCounter; i++) {
                    calculateOrderById(i);
                }
                
                // Update final summary
                updateFinalSummary();
            }
            
            function calculateOrderById(orderId) {
                // Get all rows for this order
                const rows = document.querySelectorAll(`#mealTableBody${orderId} .item-row`);
                const numPeople = rows.length;
                
                // Get total expenses from input for this order
                const deliveryTotal = parseFloat(document.querySelector(`#expenseTable${orderId} .delivery-fee-total`).value) || 0;
                const discountTotal = parseFloat(document.querySelector(`#expenseTable${orderId} .merchant-discount`).value) || 0;
                const bagTotal = parseFloat(document.querySelector(`#expenseTable${orderId} .bag-fee-total`).value) || 0;
                
                // Calculate per person amounts
                const deliveryPerPerson = numPeople > 0 ? deliveryTotal / numPeople : 0;
                const discountPerPerson = numPeople > 0 ? discountTotal / numPeople : 0;
                const bagPerPerson = numPeople > 0 ? bagTotal / numPeople : 0;
                
                // Initialize totals
                let totalGross = 0;
                let totalBox = 0;
                let totalDelivery = 0;
                let totalDiscount = 0;
                let totalBag = 0;
                let totalNet = 0;
                
                // Update each row with calculated values
                rows.forEach((row, index) => {
                    // Get meal cost and box fee (these remain user input)
                    const mealCost = parseFloat(row.querySelector('.meal-cost').value) || 0;
                    const boxFee = parseFloat(row.querySelector('.box-fee').value) || 0;
                    
                    // Set calculated values
                    row.querySelector('.delivery-fee').value = deliveryPerPerson.toFixed(2);
                    row.querySelector('.discount').value = discountPerPerson.toFixed(2);
                    row.querySelector('.bag-fee').value = bagPerPerson.toFixed(2);
                    
                    // Calculate row totals
                    const gross = mealCost + boxFee + deliveryPerPerson;
                    const net = gross - discountPerPerson + bagPerPerson;
                    
                    // Update totals
                    totalGross += gross;
                    totalBox += boxFee;
                    totalDelivery += deliveryPerPerson;
                    totalDiscount += discountPerPerson;
                    totalBag += bagPerPerson;
                    totalNet += net;
                    
                    // Calculate percentage
                    const percentage = totalGross > 0 ? (gross / totalGross * 100) : 0;
                    row.querySelector('.percentage').textContent = `${percentage.toFixed(1)}%`;
                    row.querySelector('.net-pay').textContent = net.toFixed(2);
                });
                
                // Update order totals
                const table = document.getElementById(`mealTable${orderId}`);
                table.querySelector('.total-gross').textContent = totalGross.toFixed(2);
                table.querySelector('.total-box').textContent = totalBox.toFixed(2);
                table.querySelector('.total-delivery').textContent = totalDelivery.toFixed(2);
                table.querySelector('.total-discount').textContent = `(${totalDiscount.toFixed(2)})`;
                table.querySelector('.total-bag').textContent = totalBag.toFixed(2);
                table.querySelector('.total-net').textContent = totalNet.toFixed(2);
                
                // If this is the active order, update summary section
                if (parseInt(activeOrderId) === parseInt(orderId)) {
                    document.getElementById('summaryGross').textContent = totalGross.toFixed(2);
                    document.getElementById('summaryDiscount').textContent = `(${totalDiscount.toFixed(2)})`;
                    document.getElementById('summaryNet').textContent = totalNet.toFixed(2);
                    document.getElementById('summaryPeople').textContent = numPeople;
                    document.getElementById('summaryFood').textContent = (totalGross - totalBox - totalDelivery).toFixed(2);
                    document.getElementById('summaryBox').textContent = totalBox.toFixed(2);
                    document.getElementById('summaryDelivery').textContent = totalDelivery.toFixed(2);
                    document.getElementById('summaryBag').textContent = totalBag.toFixed(2);
                }
                
                return totalNet;
            }
            
            function updateFinalSummary() {
                // Get all unique person names across all orders
                const allPersons = new Map(); // Using Map to preserve order
                
                // Collect all person names and initialize data structure
                for (let i = 1; i <= orderCounter; i++) {
                    const rows = document.querySelectorAll(`#mealTableBody${i} .item-row`);
                rows.forEach(row => {
                        const name = row.querySelector('.person-name').value.trim();
                        if (name && !allPersons.has(name)) {
                            allPersons.set(name, {
                                totalGross: 0,
                                totalBox: 0,
                                totalDelivery: 0,
                                totalDiscount: 0,
                                totalBag: 0,
                                totalNet: 0,
                                totalPercentage: 0
                            });
                        }
                    });
                }
                
                // Collect amounts and details for each person from each order
                for (let i = 1; i <= orderCounter; i++) {
                    const rows = document.querySelectorAll(`#mealTableBody${i} .item-row`);
                    
                    rows.forEach(row => {
                        const name = row.querySelector('.person-name').value.trim();
                        if (name) {
                            const amount = parseFloat(row.querySelector('.net-pay').textContent) || 0;
                            const mealCost = parseFloat(row.querySelector('.meal-cost').value) || 0;
                            const boxFee = parseFloat(row.querySelector('.box-fee').value) || 0;
                            const deliveryFee = parseFloat(row.querySelector('.delivery-fee').value) || 0;
                            const discount = parseFloat(row.querySelector('.discount').value) || 0;
                            const bagFee = parseFloat(row.querySelector('.bag-fee').value) || 0;
                            
                            const personData = allPersons.get(name);
                            personData.totalGross += mealCost + boxFee + deliveryFee;
                            personData.totalBox += boxFee;
                            personData.totalDelivery += deliveryFee;
                            personData.totalDiscount += discount;
                            personData.totalBag += bagFee;
                            personData.totalNet += amount;
                            // 百分比计算基于总金额
                            personData.totalPercentage = (personData.totalGross / getTotalGrossAcrossAllOrders() * 100);
                            
                            allPersons.set(name, personData);
                        }
                    });
                }
                
                // Generate the final summary table
                const tbody = document.getElementById('finalSummaryTableBody');
                tbody.innerHTML = '';
                
                let index = 1;
                let grandTotal = 0;
                let finalTotalGross = 0;
                let finalTotalBox = 0;
                let finalTotalDelivery = 0;
                let finalTotalDiscount = 0;
                let finalTotalBag = 0;
                let finalTotalNet = 0;
                
                allPersons.forEach((data, name) => {
                    const row = document.createElement('tr');
                    const displayIndex = index < 10 ? `0${index}` : index;
                    
                    let rowHTML = `
                        <td>${displayIndex}</td>
                        <td>${name}</td>
                        <td class="yellow-bg">${data.totalGross.toFixed(2)}</td>
                        <td class="yellow-bg">${data.totalBox.toFixed(2)}</td>
                        <td class="yellow-bg">${data.totalDelivery.toFixed(2)}</td>
                        <td class="light-blue-bg">${data.totalDiscount.toFixed(2)}</td>
                        <td class="light-blue-bg">${data.totalBag.toFixed(2)}</td>
                        <td class="orange-bg">${data.totalPercentage.toFixed(1)}%</td>
                        <td>${data.totalNet.toFixed(2)}</td>
                        <td class="grand-total-column">${data.totalNet.toFixed(2)}</td>
                    `;
                    
                    row.innerHTML = rowHTML;
                    tbody.appendChild(row);
                    
                    // Update totals
                    finalTotalGross += data.totalGross;
                    finalTotalBox += data.totalBox;
                    finalTotalDelivery += data.totalDelivery;
                    finalTotalDiscount += data.totalDiscount;
                    finalTotalBag += data.totalBag;
                    finalTotalNet += data.totalNet;
                    grandTotal += data.totalNet;
                    
                    index++;
                });
                
                // Update footer totals
                document.getElementById('finalTotalGross').textContent = finalTotalGross.toFixed(2);
                document.getElementById('finalTotalBox').textContent = finalTotalBox.toFixed(2);
                document.getElementById('finalTotalDelivery').textContent = finalTotalDelivery.toFixed(2);
                document.getElementById('finalTotalDiscount').textContent = finalTotalDiscount.toFixed(2);
                document.getElementById('finalTotalBag').textContent = finalTotalBag.toFixed(2);
                document.getElementById('finalTotalPercentage').textContent = '100%';
                document.getElementById('finalTotalNet').textContent = finalTotalNet.toFixed(2);
                
                // Update grand total
                document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
            }
            
            function getTotalGrossAcrossAllOrders() {
                let total = 0;
                for (let i = 1; i <= orderCounter; i++) {
                    const grossElement = document.querySelector(`#mealTable${i} .total-gross`);
                    if (grossElement) {
                        total += parseFloat(grossElement.textContent) || 0;
                    }
                }
                return total;
            }
            
            function clearAllData() {
                if (confirm('確定要清除所有數據嗎？此操作無法恢復。')) {
                    // Reset order counter
                    orderCounter = 1;
                    rowCounters = { 1: 1 };
                    activeOrderId = 1;
                    
                    // Clear tabs (keep first tab only)
                    const orderTabs = document.getElementById('orderTabs');
                    while (orderTabs.children.length > 2) {
                        orderTabs.removeChild(orderTabs.children[1]); // Remove second tab (after first tab, before + button)
                    }
                    
                    // Clear order contents (keep first order only)
                    const orderContents = document.getElementById('orderContents');
                    while (orderContents.children.length > 1) {
                        orderContents.removeChild(orderContents.lastChild);
                    }
                    
                    // Reset first order
                    document.querySelectorAll('.order-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.order-tab-content').forEach(content => content.classList.remove('active'));
                    document.querySelector('.order-tab[data-order-id="1"]').classList.add('active');
                    document.querySelector('.order-tab-content[data-order-id="1"]').classList.add('active');
                    
                    // Clear rows in first order (keep first row)
                    const tbody = document.getElementById('mealTableBody1');
                    while (tbody.children.length > 1) {
                        tbody.removeChild(tbody.lastChild);
                    }
                    
                    // Reset the first row
                    const firstRow = tbody.firstChild;
                    firstRow.querySelector('.person-name').value = '';
                    firstRow.querySelector('.meal-cost').value = '0';
                    firstRow.querySelector('.box-fee').value = '0';
                    firstRow.querySelector('.delivery-fee').value = '0';
                    firstRow.querySelector('.discount').value = '0';
                    firstRow.querySelector('.bag-fee').value = '0';
                    
                    // Reset expense table
                    document.querySelector('#expenseTable1 .delivery-fee-total').value = '0';
                    document.querySelector('#expenseTable1 .merchant-discount').value = '0';
                    document.querySelector('#expenseTable1 .bag-fee-total').value = '0';
                    
                    // Clear final summary table
                    document.getElementById('finalSummaryTableBody').innerHTML = '';
                    
                    // Update final summary headers
                    updateFinalSummaryHeaders();
                    
                    // Recalculate
                    calculateAll();
                }
            }
            
            function saveData() {
                // In a real app, this would save to localStorage or server
                alert('數據已保存！在實際應用中，這會將數據保存到瀏覽器或伺服器。');
            }
            
            function addSampleData() {
                // Add data to first order
                const firstOrder = document.querySelector('#mealTableBody1 .item-row');
                firstOrder.querySelector('.person-name').value = 'hou';
                firstOrder.querySelector('.meal-cost').value = '40.00';
                firstOrder.querySelector('.box-fee').value = '2.00';
                
                // Set expense data for first order
                document.querySelector('#expenseTable1 .delivery-fee-total').value = '4.00';
                document.querySelector('#expenseTable1 .merchant-discount').value = '20.00';
                document.querySelector('#expenseTable1 .bag-fee-total').value = '2.00';
                
                // Add more rows to first order
                addNewRow(1);
                const secondRow = document.querySelectorAll('#mealTableBody1 .item-row')[1];
                secondRow.querySelector('.person-name').value = 'julia';
                secondRow.querySelector('.meal-cost').value = '40.00';
                secondRow.querySelector('.box-fee').value = '2.00';
                
                addNewRow(1);
                const thirdRow = document.querySelectorAll('#mealTableBody1 .item-row')[2];
                thirdRow.querySelector('.person-name').value = 'Karen';
                thirdRow.querySelector('.meal-cost').value = '40.00';
                thirdRow.querySelector('.box-fee').value = '2.00';
                
                // Add second order
                addNewOrder();
                const firstRow2 = document.querySelector('#mealTableBody2 .item-row');
                firstRow2.querySelector('.person-name').value = 'GARY';
                firstRow2.querySelector('.meal-cost').value = '15.00';
                firstRow2.querySelector('.box-fee').value = '1.00';
                
                // Set expense data for second order
                document.querySelector('#expenseTable2 .delivery-fee-total').value = '1.00';
                document.querySelector('#expenseTable2 .merchant-discount').value = '30.00';
                document.querySelector('#expenseTable2 .bag-fee-total').value = '1.00';
                
                // Add more rows to second order
                addNewRow(2);
                const secondRow2 = document.querySelectorAll('#mealTableBody2 .item-row')[1];
                secondRow2.querySelector('.person-name').value = 'JUANE';
                secondRow2.querySelector('.meal-cost').value = '15.00';
                secondRow2.querySelector('.box-fee').value = '1.00';
                
                addNewRow(2);
                const thirdRow2 = document.querySelectorAll('#mealTableBody2 .item-row')[2];
                thirdRow2.querySelector('.person-name').value = 'HOU';
                thirdRow2.querySelector('.meal-cost').value = '15.00';
                thirdRow2.querySelector('.box-fee').value = '1.00';
                
                // Calculate and update
                calculateAll();
                updateFinalSummary();
                
                // Switch back to first tab
                switchTab('1');
            }
            
            // 生成PDF
            function generatePDF(exportContent, pageSize, orientation, filename) {
                const { jsPDF } = window.jspdf;
                
                // 初始化jsPDF
                const pdf = new jsPDF({
                    orientation: orientation,
                    unit: 'mm',
                    format: pageSize
                });
                
                // 创建一个容器来合成整个PDF内容
                const pdfContent = document.createElement('div');
                pdfContent.style.position = 'absolute';
                pdfContent.style.left = '-9999px';
                pdfContent.style.width = orientation === 'landscape' ? '1100px' : '800px';
                document.body.appendChild(pdfContent);
                
                // 创建样式容器以保留原始样式
                const styleContainer = document.createElement('div');
                styleContainer.style.padding = '20px';
                styleContainer.style.backgroundColor = 'white';
                styleContainer.style.fontFamily = 'Arial, "Microsoft JhengHei", sans-serif';
                
                // 创建标题
                const mainTitle = document.createElement('h1');
                mainTitle.style.textAlign = 'center';
                mainTitle.style.margin = '10px 0 20px 0';
                mainTitle.style.color = '#4682B4';
                mainTitle.style.fontSize = '24px';
                mainTitle.textContent = 'CJT體重增加費用分攤計算';
                styleContainer.appendChild(mainTitle);
                
                // 添加订单摘要部分
                if (exportContent === 'all' || exportContent === 'summary') {
                    // 创建订单摘要区域
                    const summarySection = document.createElement('div');
                    summarySection.style.marginBottom = '20px';
                    
                    // 添加摘要标题
                    const summaryTitle = document.createElement('h2');
                    summaryTitle.style.color = '#5cb85c';
                    summaryTitle.style.fontSize = '18px';
                    summaryTitle.style.marginBottom = '10px';
                    summaryTitle.style.borderBottom = '2px solid #5cb85c';
                    summaryTitle.style.paddingBottom = '5px';
                    summaryTitle.textContent = '訂單摘要';
                    summarySection.appendChild(summaryTitle);
                    
                    // 创建摘要表格
                    const summaryTable = document.createElement('table');
                    summaryTable.style.width = '100%';
                    summaryTable.style.borderCollapse = 'collapse';
                    summaryTable.style.marginBottom = '20px';
                    summaryTable.style.border = '1px solid #ddd';
                    
                    // 获取原始数据
                    const grossTotal = document.getElementById('summaryGross').textContent;
                    const discountTotal = document.getElementById('summaryDiscount').textContent;
                    const netTotal = document.getElementById('summaryNet').textContent;
                    const peopleCount = document.getElementById('summaryPeople').textContent;
                    const foodTotal = document.getElementById('summaryFood').textContent;
                    const boxTotal = document.getElementById('summaryBox').textContent;
                    const deliveryTotal = document.getElementById('summaryDelivery').textContent;
                    const bagTotal = document.getElementById('summaryBag').textContent;
                    
                    summaryTable.innerHTML = `
                        <tr>
                            <th style="padding: 8px; border: 1px solid #ddd; background-color: #f8f8f8; width: 20%;">項目</th>
                            <th style="padding: 8px; border: 1px solid #ddd; background-color: #f8f8f8; width: 30%;">金額</th>
                            <th style="padding: 8px; border: 1px solid #ddd; background-color: #f8f8f8; width: 20%;">項目</th>
                            <th style="padding: 8px; border: 1px solid #ddd; background-color: #f8f8f8; width: 30%;">金額</th>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">總毛額</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${grossTotal}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">餐點總額</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${foodTotal}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">總優惠</td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #e74c3c;">${discountTotal}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">外賣盒費</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${boxTotal}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">總淨額</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${netTotal}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">配送費</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${deliveryTotal}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">人數</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${peopleCount}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">膠袋費</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${bagTotal}</td>
                        </tr>
                    `;
                    
                    summarySection.appendChild(summaryTable);
                    styleContainer.appendChild(summarySection);
                }
                
                // 添加总结算表
                if (exportContent === 'all' || exportContent === 'summary') {
                    const finalTable = document.querySelector('#finalSummaryTable').cloneNode(true);
                    
                    // 创建总结算区域
                    const finalSection = document.createElement('div');
                    finalSection.style.marginTop = '20px';
                    
                    // 添加结算标题
                    const finalTitle = document.createElement('h2');
                    finalTitle.style.color = '#5cb85c';
                    finalTitle.style.fontSize = '18px';
                    finalTitle.style.marginBottom = '10px';
                    finalTitle.style.borderBottom = '2px solid #5cb85c';
                    finalTitle.style.paddingBottom = '5px';
                    finalTitle.textContent = '總結算表';
                    finalSection.appendChild(finalTitle);
                    
                    // 格式化总结算表
                    const newFinalTable = document.createElement('table');
                    newFinalTable.style.width = '100%';
                    newFinalTable.style.borderCollapse = 'collapse';
                    newFinalTable.style.border = '1px solid #ddd';
                    
                    // 复制表头
                    const thead = finalTable.querySelector('thead');
                    if (thead) {
                        const newThead = document.createElement('thead');
                        
                        // 处理第一行表头（如果有）
                        const headerRow1 = thead.querySelector('tr:first-child');
                        if (headerRow1) {
                            const newHeaderRow1 = document.createElement('tr');
                            headerRow1.querySelectorAll('th').forEach(th => {
                                const newTh = document.createElement('th');
                                newTh.innerHTML = th.innerHTML;
                                newTh.style.padding = '8px';
                                newTh.style.border = '1px solid #ddd';
                                newTh.style.backgroundColor = '#f2f9f2';
                                newTh.style.textAlign = 'center';
                                newTh.style.fontWeight = 'bold';
                                if (th.rowSpan) newTh.rowSpan = th.rowSpan;
                                if (th.colSpan) newTh.colSpan = th.colSpan;
                                
                                if (th.classList.contains('order-group-header')) {
                                    newTh.style.backgroundColor = '#e8f4f8';
                                    newTh.style.borderBottom = '1px solid #bbd8e7';
                                }
                                
                                if (th.classList.contains('grand-total-column')) {
                                    newTh.style.backgroundColor = '#d0e9d0';
                                    newTh.style.borderLeft = '2px solid #5cb85c';
                                }
                                
                                newHeaderRow1.appendChild(newTh);
                            });
                            newThead.appendChild(newHeaderRow1);
                        }
                        
                        // 处理第二行表头（如果有）
                        const headerRow2 = thead.querySelector('tr:nth-child(2)');
                        if (headerRow2) {
                            const newHeaderRow2 = document.createElement('tr');
                            headerRow2.querySelectorAll('th').forEach(th => {
                                const newTh = document.createElement('th');
                                newTh.innerHTML = th.innerHTML;
                                newTh.style.padding = '8px';
                                newTh.style.border = '1px solid #ddd';
                                newTh.style.backgroundColor = '#f2f9f2';
                                newTh.style.textAlign = 'center';
                                newTh.style.fontWeight = 'bold';
                                
                                if (th.classList.contains('yellow-bg')) {
                                    newTh.style.backgroundColor = '#FFFD9A';
                                } else if (th.classList.contains('light-blue-bg')) {
                                    newTh.style.backgroundColor = '#B8E2F2';
                                } else if (th.classList.contains('orange-bg')) {
                                    newTh.style.backgroundColor = '#FFC87C';
                                }
                                
                                newHeaderRow2.appendChild(newTh);
                            });
                            newThead.appendChild(newHeaderRow2);
                        }
                        
                        newFinalTable.appendChild(newThead);
                    }
                    
                    // 复制表体
                    const tbody = finalTable.querySelector('tbody');
                    if (tbody) {
                        const newTbody = document.createElement('tbody');
                        const rows = tbody.querySelectorAll('tr');
                        
                        rows.forEach((row, rowIndex) => {
                            const newRow = document.createElement('tr');
                            // 设置交替行的背景色
                            if (rowIndex % 2 === 1) {
                                newRow.style.backgroundColor = '#f9f9f9';
                            }
                            
                            row.querySelectorAll('td').forEach(cell => {
                                const newCell = document.createElement('td');
                                newCell.innerHTML = cell.innerHTML;
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.classList.contains('yellow-bg')) {
                                    newCell.style.backgroundColor = '#FFFD9A';
                                } else if (cell.classList.contains('light-blue-bg')) {
                                    newCell.style.backgroundColor = '#B8E2F2';
                                } else if (cell.classList.contains('orange-bg')) {
                                    newCell.style.backgroundColor = '#FFC87C';
                                } else if (cell.classList.contains('grand-total-column')) {
                                    newCell.style.backgroundColor = '#e9f7e9';
                                    newCell.style.borderLeft = '2px solid #5cb85c';
                                    newCell.style.fontWeight = 'bold';
                                }
                                
                                newRow.appendChild(newCell);
                            });
                            
                            newTbody.appendChild(newRow);
                        });
                        
                        newFinalTable.appendChild(newTbody);
                    }
                    
                    // 复制表脚
                    const tfoot = finalTable.querySelector('tfoot');
                    if (tfoot) {
                        const newTfoot = document.createElement('tfoot');
                        const footerRow = tfoot.querySelector('tr');
                        if (footerRow) {
                            const newFooterRow = document.createElement('tr');
                            footerRow.querySelectorAll('td').forEach(cell => {
                                const newCell = document.createElement('td');
                                // 如果单元格有ID，获取对应ID的内容
                                if (cell.id) {
                                    const originalCell = document.getElementById(cell.id);
                                    if (originalCell) {
                                        newCell.textContent = originalCell.textContent;
                                    }
                                } else {
                                    newCell.innerHTML = cell.innerHTML;
                                }
                                
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.backgroundColor = '#f0fff0';
                                newCell.style.fontWeight = 'bold';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.id === 'grandTotal') {
                                    newCell.style.backgroundColor = '#e9f7e9';
                                    newCell.style.borderLeft = '2px solid #5cb85c';
                                }
                                
                                newFooterRow.appendChild(newCell);
                            });
                            
                            newTfoot.appendChild(newFooterRow);
                        }
                        
                        newFinalTable.appendChild(newTfoot);
                    }
                    
                    finalSection.appendChild(newFinalTable);
                    styleContainer.appendChild(finalSection);
                }
                
                // 添加当前订单详情（如果需要）
                if (exportContent === 'current') {
                    const currentOrder = document.querySelector('.order-tab-content.active');
                    const orderId = currentOrder.dataset.orderId;
                    
                    // 创建订单区域
                    const orderSection = document.createElement('div');
                    orderSection.style.marginTop = '20px';
                    
                    // 添加订单标题
                    const orderTitle = document.createElement('h2');
                    orderTitle.style.color = '#4682B4';
                    orderTitle.style.fontSize = '18px';
                    orderTitle.style.marginBottom = '10px';
                    orderTitle.style.borderBottom = '2px solid #4682B4';
                    orderTitle.style.paddingBottom = '5px';
                    orderTitle.textContent = `訂單 ${orderId} 明細`;
                    orderSection.appendChild(orderTitle);
                    
                    // 处理订单表格
                    const orderTables = currentOrder.querySelectorAll('table');
                    orderTables.forEach(table => {
                        const newTable = createFormattedTable(table);
                        orderSection.appendChild(newTable);
                        // 添加一些间距
                        const spacer = document.createElement('div');
                        spacer.style.height = '20px';
                        orderSection.appendChild(spacer);
                    });
                    
                    styleContainer.appendChild(orderSection);
                }
                
                // 添加所有订单详情（如果需要）
                if (exportContent === 'all') {
                    const allOrders = document.querySelectorAll('.order-tab-content');
                    allOrders.forEach(order => {
                        const orderId = order.dataset.orderId;
                        
                        // 创建订单区域
                        const orderSection = document.createElement('div');
                        orderSection.style.marginTop = '20px';
                        orderSection.style.pageBreakBefore = 'always'; // 每个订单从新页开始
                        
                        // 添加订单标题
                        const orderTitle = document.createElement('h2');
                        let titleColor = '#4682B4'; // 默认蓝色
                        // 根据订单ID设置不同颜色
                        if (orderId === '2') titleColor = '#9370DB';
                        else if (orderId === '3') titleColor = '#e67e22';
                        else if (orderId === '4') titleColor = '#16a085';
                        else if (orderId === '5') titleColor = '#c0392b';
                        
                        orderTitle.style.color = titleColor;
                        orderTitle.style.fontSize = '18px';
                        orderTitle.style.marginBottom = '10px';
                        orderTitle.style.borderBottom = `2px solid ${titleColor}`;
                        orderTitle.style.paddingBottom = '5px';
                        orderTitle.textContent = `訂單 ${orderId} 明細`;
                        orderSection.appendChild(orderTitle);
                        
                        // 处理订单表格
                        const orderTables = order.querySelectorAll('table');
                        orderTables.forEach(table => {
                            const newTable = createFormattedTable(table);
                            orderSection.appendChild(newTable);
                            // 添加一些间距
                            const spacer = document.createElement('div');
                            spacer.style.height = '20px';
                            orderSection.appendChild(spacer);
                        });
                        
                        styleContainer.appendChild(orderSection);
                    });
                }
                
                // 添加页脚
                const footer = document.createElement('div');
                footer.style.marginTop = '30px';
                footer.style.textAlign = 'center';
                footer.style.fontSize = '12px';
                footer.style.color = '#888';
                footer.textContent = `CJT體重增加費用分攤計算器 © ${new Date().getFullYear()}`;
                styleContainer.appendChild(footer);
                
                pdfContent.appendChild(styleContainer);
                
                // 使用html2canvas将内容转换为图片
                html2canvas(styleContainer, {
                    scale: 2, // 提高清晰度
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                }).then(canvas => {
                    // 添加到PDF
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const margin = 10;
                    
                    // 计算图像尺寸以适应页面
                    const imgWidth = pdfWidth - (2 * margin);
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // 添加图像到PDF，如果高度超过页面高度，会自动添加新页
                    pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
                    
                    // 完成PDF
                    loadingIndicator.style.display = 'none';
                    overlay.style.display = 'none';
                    document.body.removeChild(pdfContent);
                    
                    // 下载PDF
                    pdf.save(filename);
                });
                
                // 创建格式化表格的辅助函数
                function createFormattedTable(originalTable) {
                    const newTable = document.createElement('table');
                    newTable.style.width = '100%';
                    newTable.style.borderCollapse = 'collapse';
                    newTable.style.marginBottom = '10px';
                    newTable.style.border = '1px solid #ddd';
                    
                    // 复制表头
                    const thead = originalTable.querySelector('thead');
                    if (thead) {
                        const newThead = document.createElement('thead');
                        thead.querySelectorAll('tr').forEach(row => {
                            const newRow = document.createElement('tr');
                            
                            row.querySelectorAll('th').forEach(cell => {
                                const newCell = document.createElement('th');
                                newCell.textContent = cell.textContent;
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.backgroundColor = '#f7f7f7';
                                newCell.style.fontWeight = 'bold';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.classList.contains('yellow-bg')) {
                                    newCell.style.backgroundColor = '#FFFD9A';
                                } else if (cell.classList.contains('light-blue-bg')) {
                                    newCell.style.backgroundColor = '#B8E2F2';
                                } else if (cell.classList.contains('orange-bg')) {
                                    newCell.style.backgroundColor = '#FFC87C';
                                }
                                
                                newRow.appendChild(newCell);
                            });
                            
                            newThead.appendChild(newRow);
                        });
                        
                        newTable.appendChild(newThead);
                    }
                    
                    // 复制表体
                    const tbody = originalTable.querySelector('tbody');
                    if (tbody) {
                        const newTbody = document.createElement('tbody');
                        
                        tbody.querySelectorAll('tr').forEach((row, rowIndex) => {
                            const newRow = document.createElement('tr');
                            // 设置交替行的背景色
                            if (rowIndex % 2 === 1) {
                                newRow.style.backgroundColor = '#f9f9f9';
                            }
                            
                            row.querySelectorAll('td').forEach(cell => {
                                const newCell = document.createElement('td');
                                
                                // 处理输入框
                                if (cell.querySelector('input')) {
                                    newCell.textContent = cell.querySelector('input').value;
                                } else if (cell.classList.contains('percentage')) {
                                    newCell.textContent = cell.textContent;
                                } else if (cell.classList.contains('net-pay')) {
                                    newCell.textContent = cell.textContent;
                                } else if (cell.querySelector('.remove-btn')) {
                                    // 忽略删除按钮
                                    newCell.textContent = '';
                                } else {
                                    newCell.textContent = cell.textContent;
                                }
                                
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.classList.contains('yellow-bg')) {
                                    newCell.style.backgroundColor = '#FFFD9A';
                                } else if (cell.classList.contains('light-blue-bg')) {
                                    newCell.style.backgroundColor = '#B8E2F2';
                                } else if (cell.classList.contains('orange-bg')) {
                                    newCell.style.backgroundColor = '#FFC87C';
                                }
                                
                                newRow.appendChild(newCell);
                            });
                            
                            newTbody.appendChild(newRow);
                        });
                        
                        newTable.appendChild(newTbody);
                    }
                    
                    // 复制表脚
                    const tfoot = originalTable.querySelector('tfoot');
                    if (tfoot) {
                        const newTfoot = document.createElement('tfoot');
                        
                        tfoot.querySelectorAll('tr').forEach(row => {
                            const newRow = document.createElement('tr');
                            
                            row.querySelectorAll('td').forEach(cell => {
                                const newCell = document.createElement('td');
                                newCell.textContent = cell.textContent;
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.backgroundColor = '#e9f5ff';
                                newCell.style.fontWeight = 'bold';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.classList.contains('red-text')) {
                                    newCell.style.color = '#e74c3c';
                                }
                                
                                newRow.appendChild(newCell);
                            });
                            
                            newTfoot.appendChild(newRow);
                        });
                        
                        newTable.appendChild(newTfoot);
                    }
                    
                    return newTable;
                }
            }
            
            // 在"总结算表"上添加ID，方便PDF导出
            document.querySelector('.calculator-section:last-child').id = 'finalSummarySection';
            
            // 添加删除订单确认对话框
            let deleteOrderDialog = document.createElement('div');
            deleteOrderDialog.className = 'delete-confirm-dialog';
            deleteOrderDialog.id = 'deleteOrderDialog';
            deleteOrderDialog.innerHTML = `
                <h3>刪除訂單</h3>
                <p>您確定要刪除此訂單嗎？此操作無法恢復，且訂單中的所有數據都將丟失。</p>
                <div class="buttons">
                    <button class="cancel-btn">取消</button>
                    <button class="confirm-btn">確定刪除</button>
                </div>
            `;
            document.body.appendChild(deleteOrderDialog);
            
            // 显示删除订单确认对话框
            function showDeleteOrderConfirm(orderId) {
                const dialog = document.getElementById('deleteOrderDialog');
                const overlay = document.getElementById('overlay');
                
                if (dialog && overlay) {
                    dialog.style.display = 'block';
                    overlay.style.display = 'block';
                    
                    // 设置确认按钮事件
                    const confirmBtn = dialog.querySelector('.confirm-btn');
                    if (confirmBtn) {
                        // 移除之前可能存在的事件监听器
                        const newConfirmBtn = confirmBtn.cloneNode(true);
                        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                        
                        // 添加新的事件监听器
                        newConfirmBtn.addEventListener('click', function() {
                            deleteOrder(orderId);
                        });
                    }
                    
                    // 设置取消按钮事件
                    const cancelBtn = dialog.querySelector('.cancel-btn');
                    if (cancelBtn) {
                        // 移除之前可能存在的事件监听器
                        const newCancelBtn = cancelBtn.cloneNode(true);
                        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                        
                        // 添加新的事件监听器
                        newCancelBtn.addEventListener('click', hideDeleteOrderConfirm);
                    }
                }
            }
            
            // 隐藏删除订单确认对话框
            function hideDeleteOrderConfirm() {
                const dialog = document.getElementById('deleteOrderDialog');
                if (dialog) {
                    dialog.style.display = 'none';
                }
                
                const overlay = document.getElementById('overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
            
            // 删除订单
            function deleteOrder(orderId) {
                // 1. 删除订单标签
                const orderTab = document.querySelector(`.order-tab[data-order-id="${orderId}"]`);
                if (orderTab) {
                    orderTab.remove();
                }
                
                // 2. 删除订单内容
                const orderContent = document.querySelector(`.order-tab-content[data-order-id="${orderId}"]`);
                if (orderContent) {
                    orderContent.remove();
                }
                
                // 3. 更新订单计数（不减少orderCounter，只是重新排序）
                renumberOrders();
                
                // 4. 如果当前活动的是被删除的订单，切换到订单1
                if (parseInt(activeOrderId) === parseInt(orderId)) {
                    switchTab('1');
                }
                
                // 5. 更新总结算表
                updateFinalSummaryHeaders();
                
                // 6. 自动重新计算
                calculateAll();
                updateFinalSummary();
                
                // 7. 关闭确认对话框和遮罩层
                hideDeleteOrderConfirm();
            }
            
            // 重新对订单编号
            function renumberOrders() {
                // 获取所有订单标签和内容
                const orderTabs = document.querySelectorAll('.order-tab');
                const orderContents = document.querySelectorAll('.order-tab-content');
                
                // 从第2个订单开始重新编号（第1个订单保持不变）
                for (let i = 1; i < orderTabs.length; i++) {
                    if (orderTabs[i].id !== 'addOrderTabBtn') {
                        const newOrderId = i + 1;
                        const oldOrderId = orderTabs[i].dataset.orderId;
                        
                        // 更新标签
                        orderTabs[i].textContent = `訂單 ${newOrderId}`;
                        orderTabs[i].dataset.orderId = newOrderId;
                        
                        // 更新删除按钮
                        const deleteBtn = orderTabs[i].querySelector('.order-delete-btn');
                        if (deleteBtn) {
                            deleteBtn.dataset.orderId = newOrderId;
                        }
                        
                        // 如果找到对应的内容区域，更新其ID
                        const content = document.querySelector(`.order-tab-content[data-order-id="${oldOrderId}"]`);
                        if (content) {
                            content.dataset.orderId = newOrderId;
                            
                            // 更新内容区域内的ID和引用
                            const mealTable = content.querySelector('.meal-table');
                            const mealTableBody = content.querySelector('.meal-table-body');
                            const addRowBtn = content.querySelector('.add-row-btn');
                            const expenseTable = content.querySelector('.expense-table');
                            const expenseTableBody = content.querySelector('.expense-table-body');
                            
                            if (mealTable) mealTable.id = `mealTable${newOrderId}`;
                            if (mealTableBody) mealTableBody.id = `mealTableBody${newOrderId}`;
                            if (addRowBtn) addRowBtn.dataset.orderId = newOrderId;
                            if (expenseTable) expenseTable.id = `expenseTable${newOrderId}`;
                            if (expenseTableBody) expenseTableBody.id = `expenseTableBody${newOrderId}`;
                            
                            // 更新表头文本
                            const headers = content.querySelectorAll('.section-header');
                            headers.forEach(header => {
                                header.textContent = header.textContent.replace(/訂單 \d+/g, `訂單 ${newOrderId}`);
                            });
                        }
                        
                        // 更新rowCounters对象
                        rowCounters[newOrderId] = rowCounters[oldOrderId];
                        delete rowCounters[oldOrderId];
                    }
                }
            }
        });
    </script>
</body>
</html>
