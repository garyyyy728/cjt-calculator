<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CJT體重增加費用分攤計算器</title>
    <!-- 添加PDF导出所需的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 添加字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #9b59b6; 
            --yellow: #fef9e7;  
            --light-blue: #e8f8fd;  
            --orange: #fff5eb;  
            --green: #e8f8f5;  
            --border-color: #e0e0e0;
            --header-bg: #f7f7f7;
            --button-hover: #2980b9;
            --box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            --border-radius: 10px;
            
            /* 定义多个订单颜色 */
            --order1-color: #3498db; 
            --order1-color-light: #e8f7fe; 
            --order1-color-dark: #2980b9; 
            
            --order2-color: #9b59b6; 
            --order2-color-light: #f5eafa; 
            --order2-color-dark: #8e44ad; 
            
            --order3-color: #e67e22; 
            --order3-color-light: #fef2e7; 
            --order3-color-dark: #d35400; 
            
            --order4-color: #16a085; 
            --order4-color-light: #e8f8f5; 
            --order4-color-dark: #0e6251; 
            
            --order5-color: #e74c3c; 
            --order5-color-light: #fdedec; 
            --order5-color-dark: #c0392b; 
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 25px 0;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            position: relative;
            overflow: hidden;
        }
        
        header:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }
        
        h1 {
            font-size: 2.2rem;
            font-weight: 600;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .toolbar {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
            padding: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 20px;
        }
        
        button {
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            min-width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        #addOrderBtn, #calculateBtn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        #addOrderBtn i, #calculateBtn i {
            font-size: 14px;
        }
        
        #clearAllBtn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            font-weight: bold;
        }
        
        #clearAllBtn:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }
        
        .calculator-section {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        
        .calculator-section:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .section-header {
            background: linear-gradient(135deg, var(--order1-color), var(--order1-color-dark));
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 16px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-header i {
            font-size: 18px;
        }
        
        .section-header.secondary {
            background: linear-gradient(135deg, var(--secondary-color), #7D5CC1);
        }
        
        .table-container {
            overflow-x: auto;
            padding: 15px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 12px 10px;
            text-align: center;
            transition: background-color 0.2s;
        }
        
        th {
            background-color: #f5f7fa;
            color: #34495e;
            font-weight: 600;
            letter-spacing: 0.3px;
            border-bottom: 2px solid #dfe6e9;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover td {
            background-color: #f8fafc;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dfe6e9;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s;
            font-size: 14px;
            background-color: #fafafa;
        }
        
        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            background-color: white;
        }
        
        input:hover, select:hover {
            border-color: #bdc3c7;
            background-color: #ffffff;
        }
        
        input[readonly] {
            background-color: #f7f9fa;
            cursor: default;
        }
        
        .yellow-bg {
            background-color: var(--yellow);
        }
        
        .light-blue-bg {
            background-color: var(--light-blue);
        }
        
        .orange-bg {
            background-color: var(--orange);
        }
        
        .green-bg {
            background-color: var(--green);
        }
        
        .total-row {
            font-weight: bold;
            background-color: #f5f9ff;
            border-top: 2px solid #dfe6e9;
        }
        
        .total-row td {
            padding: 15px 10px;
            font-size: 15px;
        }
        
        .red-text {
            color: #e74c3c;
        }
        
        .item-row td {
            vertical-align: middle;
        }
        
        .add-row {
            margin: 20px 0;
            text-align: center;
            display: flex;
            justify-content: center;
        }
        
        .add-row-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            padding: 10px 20px;
            border-radius: 30px;
            min-width: auto;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 auto;
        }
        
        .add-row-btn:hover {
            background: linear-gradient(135deg, #27ae60, #219651);
            transform: translateY(-2px);
        }
        
        .add-row-btn:hover i {
            transform: scale(1.2);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .remove-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            background-color: #e74c3c;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transition: all 0.2s;
            margin: 0 auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .remove-btn:hover {
            background-color: #c0392b;
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        
        .remove-btn i {
            font-size: 14px;
        }
        
        .summary-section {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            flex: 1;
            min-width: 250px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .summary-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .summary-card:after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, transparent 50%, rgba(52,152,219,0.05) 50%);
            border-radius: 0 0 0 100px;
            z-index: 1;
        }
        
        .summary-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .summary-title i {
            color: var(--primary-color);
            font-size: 20px;
        }
        
        .summary-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            position: relative;
            z-index: 2;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s;
        }
        
        .summary-item:hover {
            background-color: #f9f9f9;
            transform: translateX(5px);
        }
        
        .summary-label {
            font-weight: 600;
            color: #555;
        }
        
        .order-container {
            margin-bottom: 35px;
        }
        
        /* 订单标签样式优化 */
        .order-tabs {
            display: flex;
            align-items: flex-end;
            gap: 5px;
            padding: 0 10px;
            border-bottom: 1px solid #ddd;
            position: relative;
            z-index: 5;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .order-tab {
            background: linear-gradient(135deg, #f0f3f6, #e7eaed);
            padding: 10px 20px;
            min-width: 150px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            border: 1px solid #d0d7de;
            border-bottom: none;
            margin-right: 2px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #555;
        }
        
        .order-tab.active {
            background: white;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
            color: #3498db;
            font-weight: 600;
            position: relative;
            z-index: 2;
            padding-bottom: 13px;
            margin-bottom: -1px;
        }
        
        .order-tab:hover:not(.active) {
            background: linear-gradient(135deg, #e7eaed, #dde3e7);
            transform: translateY(-2px);
        }
        
        /* 订单标签中的图标样式 */
        .order-tab i {
            font-size: 14px;
            margin-right: 5px;
        }
        
        /* 不同订单的颜色样式 */
        .order-tab[data-order-id="1"] {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            position: relative;
        }
        
        .order-tab[data-order-id="1"].active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-weight: bold;
        }
        
        .order-tab[data-order-id="2"] {
            background: #9b59b6;
            border-top: none;
            color: white;
            position: relative;
        }
        
        .order-tab[data-order-id="3"] {
            background: linear-gradient(135deg, #e8f8f5, #d1f2eb);
        }
        
        .order-tab[data-order-id="3"].active {
            background: white;
            color: #2ecc71;
        }
        
        .order-tab[data-order-id="4"] {
            background: linear-gradient(135deg, #e8f8f5, #d1f2eb);
        }
        
        .order-tab[data-order-id="4"].active {
            background: white;
            color: #2ecc71;
        }
        
        .order-tab[data-order-id="5"] {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .order-tab[data-order-id="5"].active {
            background: white;
            color: #c0392b;
        }
        
        /* 添加新訂單按钮样式修复 */
        #addOrderTabBtn {
            width: 50px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            transition: all 0.3s;
            min-width: 0;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            flex-shrink: 0;
        }
        
        #addOrderTabBtn:hover {
            background: linear-gradient(135deg, #27ae60, #219651);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        #addOrderTabBtn:active {
            transform: scale(0.95);
        }
        
        .order-tab-content {
            display: none;
        }
        
        .order-tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .final-summary {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .final-summary i {
            font-size: 20px;
        }
        
        #finalSummaryTable {
            border-collapse: separate;
            border-spacing: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        #finalSummaryTable th, #finalSummaryTable td {
            border: 1px solid #e5e9ef;
            padding: 12px 10px;
        }
        
        #finalSummaryTable th {
            background-color: #f7fcf7;
            color: #27ae60;
            font-weight: 600;
        }
        
        #finalSummaryTable tr:last-child td {
            font-weight: bold;
            background-color: #f0fff5;
            padding: 15px 10px;
        }
        
        @media (max-width: 992px) {
            .summary-section {
                flex-direction: column;
            }
            
            .summary-card {
                min-width: 100%;
            }
            
            .toolbar {
                flex-direction: column;
            }
            
            .button-group {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            button {
                width: 100%;
            }
            
            .order-tab {
                padding: 10px 15px;
                font-size: 14px;
                min-width: 110px;
            }
            
            .order-tab.active {
                padding-bottom: 13px;
            }
            
            /* 改进移动端表格显示 */
            .table-container {
                padding: 10px 0;
                margin: 0 -10px;
                width: calc(100% + 20px);
            }
            
            .meal-table {
                width: 100%;
                table-layout: fixed;
            }
            
            /* 调整移动端下的表格单元格和输入框 */
            .meal-table th, 
            .meal-table td {
                padding: 8px 5px;
                font-size: 13px;
            }
            
            .meal-table input[type="text"],
            .meal-table input[type="number"] {
                padding: 5px;
                font-size: 13px;
            }
            
            /* 确保文本输入框在移动端对齐正确 */
            .meal-table .net-pay, 
            .meal-table .percentage {
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }
        
        @media (max-width: 768px) {
            /* 针对中小屏幕的表格优化 */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .meal-table {
                min-width: 750px; /* 确保表格有最小宽度 */
            }
            
            /* 固定序号和飯友名列 */
            .meal-table th:first-child,
            .meal-table td:first-child,
            .meal-table th:nth-child(2),
            .meal-table td:nth-child(2) {
                position: sticky;
                background-color: #fff;
                z-index: 2;
            }
            
            .meal-table th:first-child,
            .meal-table td:first-child {
                left: 0;
                z-index: 3;
                border-right: 1px solid #dee2e6;
                background-color: #f8f9fa;
            }
            
            .meal-table th:nth-child(2),
            .meal-table td:nth-child(2) {
                left: 50px;
                z-index: 2;
                border-right: 2px solid #3498db;
            }
            
            /* 高亮显示飯友名输入单元格 */
            .meal-table td:nth-child(2) {
                background-color: #f0f7ff;
            }
            
            /* 确保按钮在移动端有正确的形状 */
            .bag-decrease,
            .bag-increase,
            .bag-decrease-modern,
            .bag-increase-modern {
                border-radius: 50% !important;
                overflow: hidden;
            }
            
            /* 确保添加按钮在移动端是圆角矩形 */
            #addOrderTabBtn {
                border-radius: 8px !important;
            }
            
            /* 订单标签在移动端的样式修复 */
            .order-tab {
                border-radius: 10px 10px 0 0 !important;
                overflow: hidden;
            }
        }
        
        @media (max-width: 576px) {
            .button-group {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .summary-items {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .order-tabs {
                gap: 5px;
                padding: 0 5px;
            }
            
            .order-tab {
                padding: 8px 10px;
                min-width: 90px;
                font-size: 13px;
            }
            
            #addOrderTabBtn {
                width: 40px;
                height: 40px;
                border-radius: 8px;
                font-size: 18px;
            }
            
            .section-header {
                padding: 12px 15px;
                font-size: 15px;
            }
            
            /* 手机小屏幕下更加突出飯友名輸入框 */
            .person-name {
                min-width: 90px;
                padding: 10px 6px;
                font-size: 15px;
                font-weight: 600;
            }
            
            .meal-table th:nth-child(2), 
            .meal-table td:nth-child(2) {
                min-width: 100px;
                z-index: 2;
            }
            
            /* 横向滚动表格时保持序号和姓名列固定 */
            .meal-table {
                table-layout: fixed;
            }
            
            .meal-table th:first-child,
            .meal-table td:first-child,
            .meal-table th:nth-child(2),
            .meal-table td:nth-child(2) {
                position: sticky;
                background-color: #fff;
                z-index: 5;
            }
            
            .meal-table th:first-child,
            .meal-table td:first-child {
                left: 0;
                z-index: 6;
            }
            
            .meal-table th:nth-child(2),
            .meal-table td:nth-child(2) {
                left: 40px;
            }
            
            /* 为固定列添加视觉提示 */
            .meal-table td:nth-child(2)::after {
                content: '';
                position: absolute;
                top: 0;
                right: 0;
                height: 100%;
                width: 4px;
                background: linear-gradient(90deg, rgba(0,0,0,0.05), transparent);
            }
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 10px;
            text-align: center;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        /* Additional styling for the remove buttons */
        .remove-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff4d4d);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .remove-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff3333);
            transform: scale(1.1);
        }
        
        /* 添加PDF导出相关样式 */
        #exportPdfBtn {
            background: linear-gradient(135deg, #6e5baa, #4a387d);
            font-weight: bold;
        }
        
        #exportPdfBtn:hover {
            background: linear-gradient(135deg, #5a4a8c, #3c2c69);
        }
        
        .export-options {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            width: 350px;
        }
        
        .export-options h3 {
            margin-top: 0;
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .export-option {
            margin-bottom: 15px;
        }
        
        .export-option label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .export-options .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            text-align: center;
        }
        
        .loading-indicator p {
            margin: 5px 0;
            font-size: 16px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 添加删除订单按钮的样式 */
        .order-delete-btn {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .order-tab:hover .order-delete-btn {
            opacity: 1;
        }
        
        .order-delete-btn:hover {
            color: white;
            transform: translateY(-50%) scale(1.2);
        }
        
        /* 添加删除按钮的样式（用于页面顶部的紫色区域） */
        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .delete-btn:hover {
            transform: scale(1.1);
            background-color: #c0392b;
        }
        
        /* 删除确认对话框样式 */
        .delete-confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            width: 350px;
            text-align: center;
        }
        
        .delete-confirm-dialog h3 {
            margin-top: 0;
            color: #e74c3c;
            margin-bottom: 15px;
        }
        
        .delete-confirm-dialog p {
            margin-bottom: 20px;
            color: #555;
        }
        
        .delete-confirm-dialog .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .delete-confirm-dialog .cancel-btn {
            background-color: #95a5a6;
        }
        
        .delete-confirm-dialog .confirm-btn {
            background-color: #e74c3c;
        }
        
        .delete-confirm-dialog .cancel-btn:hover {
            background-color: #7f8c8d;
        }
        
        .delete-confirm-dialog .confirm-btn:hover {
            background-color: #c0392b;
        }
        
        /* 修改总结算表样式，使订单区分更明显 */
        #finalSummaryTable th.order-column[data-order-id="1"],
        #finalSummaryTable td.order-column[data-order-id="1"] {
            background-color: var(--order1-color-light);
            border-left: 2px solid var(--order1-color);
        }
        
        #finalSummaryTable th.order-column[data-order-id="2"],
        #finalSummaryTable td.order-column[data-order-id="2"] {
            background-color: var(--order2-color-light);
            border-left: 2px solid var(--order2-color);
        }
        
        #finalSummaryTable th.order-column[data-order-id="3"],
        #finalSummaryTable td.order-column[data-order-id="3"] {
            background-color: var(--order3-color-light);
            border-left: 2px solid var(--order3-color);
        }
        
        #finalSummaryTable th.order-column[data-order-id="4"],
        #finalSummaryTable td.order-column[data-order-id="4"] {
            background-color: var(--order4-color-light);
            border-left: 2px solid var(--order4-color);
        }
        
        #finalSummaryTable th.order-column[data-order-id="5"],
        #finalSummaryTable td.order-column[data-order-id="5"] {
            background-color: var(--order5-color-light);
            border-left: 2px solid var(--order5-color);
        }
        
        #finalSummaryTable .order-group-header {
            text-align: center;
            background: linear-gradient(135deg, #e8f4f8, #d1e7f0);
            font-weight: bold;
            border-bottom: 1px solid #bbd8e7;
        }
        
        #finalSummaryTable .total-row td.order-column {
            font-weight: bold;
            color: #333;
        }
        
        #finalSummaryTable .grand-total-column {
            background-color: #e9f7e9;
            border-left: 2px solid #5cb85c;
            font-weight: bold;
        }
        
        #finalSummaryTable th.grand-total-column {
            background-color: #d0e9d0;
        }
        
        /* 为不同序号的订单设置不同的颜色 */
        .order-tab[data-order-id="1"].active,
        .order-tab-content[data-order-id="1"] .section-header {
            background: linear-gradient(to bottom, var(--order1-color), var(--order1-color-dark));
            border-color: var(--order1-color);
        }
        
        .order-tab[data-order-id="2"].active,
        .order-tab-content[data-order-id="2"] .section-header {
            background: linear-gradient(to bottom, var(--order2-color), var(--order2-color-dark));
            border-color: var(--order2-color);
        }
        
        .order-tab[data-order-id="3"].active,
        .order-tab-content[data-order-id="3"] .section-header {
            background: linear-gradient(to bottom, var(--order3-color), var(--order3-color-dark));
            border-color: var(--order3-color);
        }
        
        .order-tab[data-order-id="4"].active,
        .order-tab-content[data-order-id="4"] .section-header {
            background: linear-gradient(to bottom, var(--order4-color), var(--order4-color-dark));
            border-color: var(--order4-color);
        }
        
        .order-tab[data-order-id="5"].active,
        .order-tab-content[data-order-id="5"] .section-header {
            background: linear-gradient(to bottom, var(--order5-color), var(--order5-color-dark));
            border-color: var(--order5-color);
        }
        
        /* 非激活标签也有对应颜色但较淡 */
        .order-tab[data-order-id="1"] {
            border-top: 3px solid var(--order1-color);
            color: var(--order1-color);
        }
        
        .order-tab[data-order-id="2"] {
            border-top: 3px solid var(--order2-color);
            color: var(--order2-color);
        }
        
        .order-tab[data-order-id="3"] {
            border-top: 3px solid var(--order3-color);
            color: var(--order3-color);
        }
        
        .order-tab[data-order-id="4"] {
            border-top: 3px solid var(--order4-color);
            color: var(--order4-color);
        }
        
        .order-tab[data-order-id="5"] {
            border-top: 3px solid var(--order5-color);
            color: var(--order5-color);
        }
        
        .order-tab[data-order-id="1"]:hover {
            background-color: var(--order1-color-light);
        }
        
        .order-tab[data-order-id="2"]:hover {
            background-color: var(--order2-color-light);
        }
        
        .order-tab[data-order-id="3"]:hover {
            background-color: var(--order3-color-light);
        }
        
        .order-tab[data-order-id="4"]:hover {
            background-color: var(--order4-color-light);
        }
        
        .order-tab[data-order-id="5"]:hover {
            background-color: var(--order5-color-light);
        }
        
        /* 常用飯友功能相關樣式 */
        .frequent-friends {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }
        
        .frequent-friends-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .frequent-friends-title h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .frequent-friends-controls {
            display: flex;
            gap: 10px;
        }
        
        .friend-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .friend-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background-color: #e8f7fe;
            border-radius: 30px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #bde0f3;
            transition: all 0.2s;
        }
        
        .friend-chip:hover {
            background-color: #d0ebfa;
            transform: translateY(-2px);
        }
        
        .friend-chip i {
            font-size: 12px;
            color: #3498db;
        }
        
        .friend-chip .remove-friend {
            color: #e74c3c;
            font-size: 14px;
            opacity: 0.7;
            margin-left: 5px;
        }
        
        .friend-chip .remove-friend:hover {
            opacity: 1;
        }
        
        .add-friend-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .add-friend-form input {
            flex: 1;
            padding: 8px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .add-friend-form button {
            min-width: auto;
            padding: 8px 15px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .add-friend-form button:hover {
            background: linear-gradient(135deg, #27ae60, #219651);
        }
        
        .manage-friends-btn {
            background: transparent;
            border: 1px solid #3498db;
            color: #3498db;
            box-shadow: none;
            padding: 5px 10px;
            font-size: 13px;
            min-width: auto;
        }
        
        .manage-friends-btn:hover {
            background: rgba(52, 152, 219, 0.1);
            box-shadow: none;
        }
        
        .save-friends-btn, .load-friends-btn {
            background: transparent;
            border: 1px solid;
            box-shadow: none;
            padding: 5px 10px;
            font-size: 13px;
            min-width: auto;
        }
        
        .save-friends-btn {
            border-color: #27ae60;
            color: #27ae60;
        }
        
        .save-friends-btn:hover {
            background: rgba(39, 174, 96, 0.1);
            box-shadow: none;
        }
        
        .load-friends-btn {
            border-color: #e67e22;
            color: #e67e22;
        }
        
        .load-friends-btn:hover {
            background: rgba(230, 126, 34, 0.1);
            box-shadow: none;
        }
        
        /* 常用飯友管理對話框 */
        .friends-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            max-width: 90%;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }
        
        .friends-dialog-header {
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .friends-dialog-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .friends-dialog-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            min-width: auto;
            padding: 0;
            box-shadow: none;
        }
        
        .friends-dialog-close:hover {
            transform: scale(1.1);
            box-shadow: none;
        }
        
        .friends-dialog-body {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .friends-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .friends-table th,
        .friends-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .friends-table th {
            background: #f9f9f9;
        }
        
        .friends-dialog-footer {
            padding: 15px;
            text-align: center;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
        }
        
        .friends-dialog-footer button {
            margin-left: 10px;
            min-width: auto;
            padding: 8px 15px;
        }
        
        .delete-confirm-dialog .buttons,
        .export-options .buttons,
        .friends-dialog-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .cancel-btn:hover {
            background: linear-gradient(135deg, #7f8c8d, #6c7a7c);
            transform: translateY(-2px);
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .confirm-btn:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
        }
        
        #confirmExportBtn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        #confirmExportBtn:hover {
            background: linear-gradient(135deg, #2980b9, #1f6aa5);
            transform: translateY(-2px);
        }
        
        /* 快速金額選項的樣式 */
        .quick-amount-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .quick-amount {
            background: linear-gradient(135deg, #f5f7fa, #e4e8eb);
            border: 1px solid #dfe6e9;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-width: 48px;
            text-align: center;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .quick-amount:hover {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);
        }
        
        .quick-amount:active {
            transform: translateY(0);
            transition: all 0.1s;
        }
        
        .quick-amount.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-color: #2980b9;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
            transform: translateY(-1px);
            position: relative;
        }
        
        .quick-amount.active:after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: #3498db;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
        }
        
        /* 膠袋費控制按鈕樣式 */
        .bag-fee-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
            border-radius: 20px;
            padding: 3px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #dfe6e9;
            max-width: 150px;
            margin: 0 auto;
            position: relative;
            overflow: visible;
        }
        
        .bag-btn {
            background: linear-gradient(135deg, #f5f7fa, #e4e8eb);
            border: none;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #2c3e50;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            z-index: 2;
        }
        
        .bag-btn:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }
        
        .bag-btn:hover:after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            20% {
                transform: scale(25, 25);
                opacity: 0.3;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        .bag-btn:hover {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.2);
        }
        
        .bag-btn:active {
            transform: scale(0.92);
            box-shadow: 0 1px 2px rgba(52, 152, 219, 0.2);
            background: linear-gradient(135deg, #2980b9, #216a9a);
        }
        
        .bag-btn i {
            transition: all 0.2s;
        }
        
        .bag-btn:hover i {
            transform: scale(1.2);
        }
        
        .bag-decrease i {
            position: relative;
            left: -1px;
        }
        
        .bag-increase i {
            position: relative;
            left: 1px;
        }
        
        .bag-decrease {
            border-radius: 20px 0 0 20px;
        }
        
        .bag-increase {
            border-radius: 0 20px 20px 0;
        }
        
        .bag-fee-controls input {
            width: 60px;
            text-align: center;
            border-radius: 0;
            border: none;
            border-left: 1px solid #ecf0f1;
            border-right: 1px solid #ecf0f1;
            height: 34px;
            background: white;
            font-weight: bold;
            color: #2c3e50;
            box-shadow: none;
            margin: 0;
            padding: 0 8px;
        }
        
        .bag-fee-controls input:focus {
            box-shadow: none;
            background-color: white;
        }
        
        /* 膠袋費提示樣式 */
        .bag-fee-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            white-space: nowrap;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-weight: 500;
            letter-spacing: 0.5px;
            transform: translateY(5px);
            pointer-events: none;
        }
        
        .bag-fee-tooltip:before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid #3498db;
        }
        
        .bag-fee-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 移动端膠袋费控制按钮样式优化 */
        @media (max-width: 768px) {
            .bag-fee-controls {
                max-width: 100%;
                margin: 0 auto;
                border-radius: 25px;
                padding: 4px;
                box-shadow: 0 3px 8px rgba(0,0,0,0.1);
                overflow: visible;
            }
            
            .bag-btn {
                width: 38px;
                height: 38px;
                border-radius: 50% !important;
                font-size: 16px;
                transition: all 0.2s;
            }
            
            .bag-btn-modern {
                width: 38px;
                height: 38px;
                border-radius: 50% !important;
                font-size: 16px;
            }
            
            .bag-fee-controls input {
                height: 38px;
                width: 55px;
                font-size: 16px;
                font-weight: bold;
                border-radius: 0;
            }
            
            /* 提高点击区域的大小 */
            .bag-btn::before,
            .bag-btn-modern::before {
                content: '';
                position: absolute;
                top: -5px;
                left: -5px;
                right: -5px;
                bottom: -5px;
                z-index: -1;
            }
            
            /* 确保按钮在移动端有正确的圆形形状 */
            .bag-decrease,
            .bag-increase,
            .bag-decrease-modern,
            .bag-increase-modern,
            #addOrderTabBtn {
                border-radius: 50% !important;
                overflow: hidden;
            }
            
            /* 订单标签在移动端的样式修复 */
            .order-tab {
                border-radius: 10px 10px 0 0 !important;
                overflow: hidden;
            }
        }
        
        /* 移动端超小屏幕优化 */
        @media (max-width: 400px) {
            .table-container {
                padding: 5px 2px;
            }
            
            th, td {
                padding: 8px 3px;
                font-size: 12px;
            }
            
            .person-name {
                min-width: 85px;
                width: 85px;
                padding: 8px 4px;
            }
            
            .meal-table th:nth-child(2), 
            .meal-table td:nth-child(2) {
                min-width: 90px;
                width: 90px;
            }
            
            input[type="number"] {
                width: 100%;
                min-width: 60px;
            }
            
            .meal-table th:first-child,
            .meal-table td:first-child {
                min-width: 35px;
                width: 35px;
            }
            
            .meal-table th:nth-child(2),
            .meal-table td:nth-child(2) {
                left: 35px;
            }
            
            /* 确保添加按钮在超小屏幕上也是圆角矩形 */
            #addOrderTabBtn {
                width: 35px;
                height: 35px;
                border-radius: 6px !important;
                font-size: 16px;
            }
        }
        
        /* 膠袋費區域完全重新設計 */
        .expense-row.bag-fee-row {
            background-color: #f8fcff;
        }
        
        .expense-row.bag-fee-row td:nth-child(2) {
            background-color: #f0f7ff;
            padding: 15px;
            position: relative;
        }
        
        /* 膠袋費替代設計 - 更現代的控制器 */
        .bag-fee-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
            position: relative;
        }
        
        .bag-fee-display {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 5px 12px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            width: auto;
            margin: 0 auto;
        }
        
        .bag-fee-display i {
            font-size: 14px;
        }
        
        .bag-fee-display span {
            min-width: 24px;
            text-align: center;
        }
        
        .bag-fee-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .bag-btn-modern {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f5f7fa, #e4e8eb);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: visible;
        }
        
        .bag-btn-modern:hover {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .bag-btn-modern:active {
            transform: scale(0.95);
        }
        
        .bag-fee-label {
            font-size: 13px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: center;
        }
        
        /* 现代风格的胶袋费提示函数 */
        .modern-tooltip {
            position: absolute;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            z-index: 100;
            opacity: 0;
            transition: all 0.3s;
            white-space: nowrap;
            pointer-events: none;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* 添加小三角形 */
        .modern-tooltip::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid rgba(52, 152, 219, 0.9);
        }
        
        /* 动画显示 */
        .modern-tooltip.visible {
            opacity: 1;
            top: -50px;
        }
        
        /* 表格基础样式增强 */
        .meal-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .meal-table th, 
        .meal-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }
        
        .meal-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: relative;
        }
        
        .meal-table input[type="text"],
        .meal-table input[type="number"] {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-align: center;
            background-color: #fff;
        }
        
        /* 飯友名输入框增强 */
        .person-name {
            width: 100%;
            min-width: 90px;
            font-size: 14px;
            font-weight: 500;
            background-color: #ffffff !important;
            border: 2px solid #3498db !important;
            border-radius: 8px !important;
            padding: 8px 6px !important;
            box-shadow: 0 0 0 1px rgba(52, 152, 219, 0.2);
            text-align: center;
        }
        
        .person-name:focus {
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
            background-color: #f0f8ff !important;
            outline: none;
        }
        
        /* 修复表格单元格宽度和排版 */
        .meal-table th:first-child,
        .meal-table td:first-child {
            width: 50px;
            min-width: 50px;
        }
        
        .meal-table th:nth-child(2),
        .meal-table td:nth-child(2) {
            width: 120px;
            min-width: 120px;
        }
        
        .meal-table th:nth-child(3),
        .meal-table th:nth-child(4),
        .meal-table th:nth-child(5),
        .meal-table th:nth-child(6),
        .meal-table th:nth-child(7),
        .meal-table th:nth-child(8),
        .meal-table td:nth-child(3),
        .meal-table td:nth-child(4),
        .meal-table td:nth-child(5),
        .meal-table td:nth-child(6),
        .meal-table td:nth-child(7),
        .meal-table td:nth-child(8) {
            width: 80px;
            min-width: 80px;
        }
        
        .meal-table th:nth-child(9),
        .meal-table td:nth-child(9) {
            width: 60px;
            min-width: 60px;
        }
        
        .meal-table th:nth-child(10),
        .meal-table td:nth-child(10) {
            width: 80px;
            min-width: 80px;
        }
        
        .meal-table th:nth-child(11),
        .meal-table td:nth-child(11) {
            width: 50px;
            min-width: 50px;
        }
        
        /* 数字输入框样式增强 */
        .meal-cost,
        .box-fee,
        .delivery-fee,
        .discount,
        .bag-fee,
        .personal-discount {
            text-align: center;
            font-size: 14px;
            width: 100%;
            padding: 8px !important;
            border-radius: 4px;
            border: 1px solid #ced4da;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .meal-cost:focus,
        .box-fee:focus,
        .personal-discount:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .delivery-fee,
        .discount,
        .bag-fee {
            background-color: #f9f9f9;
            cursor: not-allowed;
        }
        
        /* 确保数字列文本对齐 */
        .net-pay, 
        .percentage {
            text-align: center;
            font-weight: 500;
        }
        
        .percentage {
            color: #e67e22;
        }
        
        .net-pay {
            color: #27ae60;
            font-weight: 600;
        }
        
        /* 表格操作列样式 */
        .meal-table th:last-child,
        .meal-table td:last-child {
            width: 50px;
            min-width: 50px;
            text-align: center;
        }
        
        /* 胶袋费按钮样式修复 */
        .bag-fee-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .bag-decrease-modern,
        .bag-increase-modern {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: #f5f5f5;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .bag-decrease-modern {
            background: #f0f3f7;
        }
        
        .bag-increase-modern {
            background: #3498db;
            color: white;
        }
        
        .bag-decrease-modern:hover,
        .bag-increase-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .bag-decrease-modern:active,
        .bag-increase-modern:active {
            transform: scale(0.95);
        }
        
        /* 胶袋费显示区域样式优化 */
        .bag-fee-display {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            width: auto;
            max-width: 120px;
            margin: 0 auto;
        }
        
        .bag-fee-container {
            background-color: #f8fcff;
            border-radius: 8px;
            padding: 4px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* 商家優惠控制样式 */
        .merchant-discount-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        .merchant-discount-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
            color: #666;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .merchant-discount-btn:hover {
            background: linear-gradient(to bottom, #e8f4ff, #d0e8ff);
            color: #3498db;
        }
        
        .merchant-discount-btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
        }
        
        /* 商家優惠提示框 */
        .merchant-discount-tooltip {
            position: absolute;
            background-color: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .merchant-discount-tooltip:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(52, 152, 219, 0.9) transparent transparent transparent;
        }
        
        .merchant-discount-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-calculator"></i> CJT體重增加費用分攤計算器</h1>
    </header>
    
    <div class="container">
        <div class="toolbar">
            <div class="button-group">
                <button id="clearAllBtn">
                    <i class="fas fa-trash-alt"></i> 清除所有
                </button>
                <button id="exportPdfBtn"><i class="fas fa-file-pdf"></i> 輸出PDF</button>
            </div>
        </div>
        
        <div class="summary-section">
            <div class="summary-card">
                <div class="summary-title"><i class="fas fa-file-invoice-dollar"></i> 訂單摘要</div>
                <div class="summary-items">
                    <div class="summary-item">
                        <div class="summary-label"><i class="fas fa-money-bill-wave"></i> 總毛額:</div>
                        <div id="summaryGross">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label"><i class="fas fa-tags"></i> 總優惠:</div>
                        <div id="summaryDiscount" class="red-text">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label"><i class="fas fa-receipt"></i> 總淨額:</div>
                        <div id="summaryNet">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label"><i class="fas fa-users"></i> 人數:</div>
                        <div id="summaryPeople">0</div>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-title"><i class="fas fa-list-alt"></i> 費用明細</div>
                <div class="summary-items">
                    <div class="summary-item">
                        <div class="summary-label"><i class="fas fa-utensils"></i> 餐點總額:</div>
                        <div id="summaryFood">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label"><i class="fas fa-box"></i> 外賣盒費:</div>
                        <div id="summaryBox">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label"><i class="fas fa-truck"></i> 配送費:</div>
                        <div id="summaryDelivery">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label"><i class="fas fa-shopping-bag"></i> 膠袋費:</div>
                        <div id="summaryBag">0.00</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 订单选项卡 -->
        <div class="order-tabs" id="orderTabs">
            <div class="order-tab active" data-order-id="1">
                <i class="fas fa-clipboard-list"></i> 訂單 1
            </div>
            <button id="addOrderTabBtn"><i class="fas fa-plus"></i></button>
        </div>
        
        <!-- 订单内容 -->
        <div id="orderContents">
            <!-- 订单1 -->
            <div class="order-tab-content active" data-order-id="1">
                <!-- 常用飯友區域 -->
                <div class="frequent-friends">
                    <div class="frequent-friends-title">
                        <h3><i class="fas fa-users"></i> 常用飯友</h3>
                        <div class="frequent-friends-controls">
                            <button class="manage-friends-btn" id="manageFriendsBtn"><i class="fas fa-cog"></i> 管理飯友</button>
                            <button class="save-friends-btn" id="saveFriendsBtn"><i class="fas fa-save"></i> 保存飯友</button>
                            <button class="load-friends-btn" id="loadFriendsBtn"><i class="fas fa-upload"></i> 加載飯友</button>
                        </div>
                    </div>
                    <div class="friend-chips friend-chips-1" id="friendChips">
                        <!-- 這裡會動態生成常用飯友按鈕 -->
                    </div>
                    <div class="add-friend-form">
                        <input type="text" id="newFriendName" placeholder="輸入新飯友名稱">
                        <button id="addFriendBtn"><i class="fas fa-plus"></i> 添加</button>
                    </div>
                </div>

                <div class="calculator-section">
                    <div class="section-header"><i class="fas fa-utensils"></i> 餐點明細及分攤 - 訂單 1</div>
                    <div class="table-container">
                        <table class="meal-table" id="mealTable1">
                            <thead>
                                <tr>
                                    <th width="5%">序號</th>
                                    <th width="10%">飯友</th>
                                    <th class="yellow-bg" width="8%">毛付</th>
                                    <th class="yellow-bg" width="8%">外賣盒</th>
                                    <th class="light-blue-bg" width="8%">配送費</th>
                                    <th class="light-blue-bg" width="8%">商家優惠</th>
                                    <th class="light-blue-bg" width="8%">膠袋費</th>
                                    <th class="green-bg" width="8%">獨享優惠</th>
                                    <th class="orange-bg" width="8%">比例</th>
                                    <th width="8%">淨付</th>
                                    <th width="5%">操作</th>
                                </tr>
                            </thead>
                            <tbody class="meal-table-body" id="mealTableBody1">
                                <!-- 初始行 -->
                                <tr class="item-row" data-row-id="1">
                                    <td>01</td>
                                    <td><input type="text" class="person-name" value="" placeholder="姓名"></td>
                                    <td class="yellow-bg"><input type="number" step="0.01" class="meal-cost" value="0" placeholder="餐費"></td>
                                    <td class="yellow-bg"><input type="number" step="0.01" class="box-fee" value="0" placeholder="盒費"></td>
                                    <td class="light-blue-bg"><input type="number" step="0.01" class="delivery-fee" value="0" readonly></td>
                                    <td class="light-blue-bg"><input type="number" step="0.01" class="discount" value="0" readonly></td>
                                    <td class="light-blue-bg"><input type="number" step="0.01" class="bag-fee" value="0" readonly></td>
                                    <td class="green-bg"><input type="number" step="0.01" class="personal-discount" value="" placeholder="個人優惠"></td>
                                    <td class="orange-bg percentage">0%</td>
                                    <td class="net-pay">0.00</td>
                                    <td><span class="remove-btn"><i class="fas fa-trash-alt"></i></span></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="2">總計</td>
                                    <td class="yellow-bg total-gross">0.00</td>
                                    <td class="yellow-bg total-box">0.00</td>
                                    <td class="light-blue-bg total-delivery">0.00</td>
                                    <td class="light-blue-bg red-text total-discount">(0.00)</td>
                                    <td class="light-blue-bg total-bag">0.00</td>
                                    <td class="green-bg red-text total-personal-discount">(0.00)</td>
                                    <td class="orange-bg total-percentage">0%</td>
                                    <td class="total-net">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="add-row">
                        <button class="add-row-btn" data-order-id="1"><i class="fas fa-user-plus"></i> 新增一行</button>
                    </div>
                </div>
                
                <div class="calculator-section">
                    <div class="section-header"><i class="fas fa-money-bill-wave"></i> 其他支出明細 - 訂單 1</div>
                    <div class="table-container">
                        <table class="expense-table" id="expenseTable1">
                            <thead>
                                <tr>
                                    <th width="30%">項目</th>
                                    <th width="20%">金額</th>
                                    <th width="30%">備註</th>
                                </tr>
                            </thead>
                            <tbody class="expense-table-body" id="expenseTableBody1">
                                <tr class="expense-row">
                                    <td><i class="fas fa-truck"></i> 配送費</td>
                                    <td><input type="number" step="0.01" class="expense-amount delivery-fee-total" value="0"></td>
                                    <td><input type="text" class="expense-note" value="配送費用"></td>
                                </tr>
                                <tr class="expense-row">
                                    <td><i class="fas fa-tags"></i> 商家優惠</td>
                                    <td>
                                        <input type="number" step="0.5" class="expense-amount merchant-discount" value="0">
                                       
                                    </td>
                                    <td>
                                        <input type="text" class="expense-note" value="由商家提供的折扣">
                                        <div class="quick-amount-options">
                                            <button class="quick-amount" data-amount="1">1元</button>
                                            <button class="quick-amount" data-amount="3">3元</button>
                                            <button class="quick-amount" data-amount="5">5元</button>
                                            <button class="quick-amount" data-amount="8">8元</button>
                                            <button class="quick-amount" data-amount="10">10元</button>
                                            <button class="quick-amount" data-amount="20">20元</button>
                                            <button class="quick-amount" data-amount="30">30元</button>
                                            <button class="quick-amount" data-amount="50">50元</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="expense-row bag-fee-row">
                                    <td><i class="fas fa-shopping-bag"></i> 膠袋費</td>
                                    <td>
                                        <!-- 旧的控制器（保留但隐藏，用于保持数据一致性） -->
                                        <div class="bag-fee-controls" style="display: none;">
                                            <button class="bag-btn bag-decrease"><i class="fas fa-minus"></i></button>
                                            <input type="number" step="1" class="expense-amount bag-fee-total" value="0" readonly>
                                            <button class="bag-btn bag-increase"><i class="fas fa-plus"></i></button>
                                        </div>
                                        
                                        <!-- 新的胶袋费控制器 -->
                                        <div class="bag-fee-container">
                                            <div class="bag-fee-display">
                                                <i class="fas fa-shopping-bag"></i>
                                                <span class="bag-fee-count">0</span>
                                                <i class="fas fa-times"></i>
                                                <span>1元</span>
                                            </div>
                                            <div class="bag-fee-buttons">
                                                <button class="bag-btn-modern bag-decrease-modern"><i class="fas fa-minus"></i></button>
                                                <button class="bag-btn-modern bag-increase-modern"><i class="fas fa-plus"></i></button>
                                            </div>
                                            <div class="bag-fee-label">環保膠袋 (每個1元)</div>
                                        </div>
                                    </td>
                                    <td><input type="text" class="expense-note" value="環保膠袋費用 (每個1元)"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 修改总结算表结构 -->
        <div class="calculator-section">
            <div class="section-header final-summary">總結算表</div>
            <div class="table-container final-summary-container">
                <table class="meal-table" id="finalSummaryTable">
                    <thead>
                        <tr>
                            <th rowspan="2" width="5%">序號</th>
                            <th rowspan="2" width="10%">飯友</th>
                            <th colspan="8" class="order-group-header">每人消費明細</th>
                            <th rowspan="2" class="grand-total-column" width="8%">合計</th>
                            <th rowspan="2" width="5%">操作</th>
                        </tr>
                        <tr>
                            <th class="yellow-bg" width="8%">毛付</th>
                            <th class="yellow-bg" width="8%">外賣盒</th>
                            <th class="light-blue-bg" width="8%">配送費</th>
                            <th class="light-blue-bg" width="8%">商家優惠</th>
                            <th class="light-blue-bg" width="8%">獨享優惠</th>
                            <th class="light-blue-bg" width="8%">膠袋費</th>
                            <th class="orange-bg" width="8%">比例</th>
                            <th width="8%">淨付</th>
                        </tr>
                    </thead>
                    <tbody id="finalSummaryTableBody">
                        <!-- 将在 JavaScript 中动态生成 -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="2">總計</td>
                            <td class="yellow-bg" id="finalTotalGross">0.00</td>
                            <td class="yellow-bg" id="finalTotalBox">0.00</td>
                            <td class="light-blue-bg" id="finalTotalDelivery">0.00</td>
                            <td class="light-blue-bg" id="finalTotalDiscount">0.00</td>
                            <td class="light-blue-bg" id="finalTotalPersonalDiscount">0.00</td>
                            <td class="light-blue-bg" id="finalTotalBag">0.00</td>
                            <td class="orange-bg" id="finalTotalPercentage">100%</td>
                            <td id="finalTotalNet">0.00</td>
                            <td class="grand-total-column" id="grandTotal">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <div class="footer">
        CJT體重增加費用分攤計算器 By GaryLEI © 2025
    </div>
    
    <!-- 添加PDF导出选项对话框 -->
    <div class="overlay" id="overlay"></div>

    <div class="export-options" id="exportOptions">
        <h3>匯出PDF選項</h3>
        <div class="export-option">
            <label for="exportContent">匯出內容：</label>
            <select id="exportContent" class="export-select">
                <option value="all">所有內容</option>
                <option value="current">當前訂單</option>
                <option value="summary">僅總結算表</option>
            </select>
        </div>
        <div class="export-option">
            <label for="pageSize">紙張大小：</label>
            <select id="pageSize" class="export-select">
                <option value="a4">A4</option>
                <option value="letter">Letter</option>
                <option value="legal">Legal</option>
            </select>
        </div>
        <div class="export-option">
            <label for="orientation">方向：</label>
            <select id="orientation" class="export-select">
                <option value="portrait">縱向</option>
                <option value="landscape">橫向</option>
            </select>
        </div>
        <div class="export-option">
            <label for="exportFilename">檔案名稱：</label>
            <input type="text" id="exportFilename" value="費用分攤計算-" class="export-select">
        </div>
        <div class="buttons">
            <button id="cancelExportBtn"><i class="fas fa-times"></i> 取消</button>
            <button id="confirmExportBtn"><i class="fas fa-file-pdf"></i> 匯出</button>
        </div>
    </div>

    <div class="loading-indicator" id="loadingIndicator">
        <div class="spinner"></div>
        <p>正在生成PDF，請稍候...</p>
    </div>
    
    <div class="delete-confirm-dialog" id="deleteOrderDialog">
        <h3>刪除訂單</h3>
        <p>您確定要刪除此訂單嗎？此操作無法恢復，且訂單中的所有數據都將丟失。</p>
        <div class="buttons">
            <button class="cancel-btn"><i class="fas fa-times"></i> 取消</button>
            <button class="confirm-btn"><i class="fas fa-trash-alt"></i> 確定刪除</button>
        </div>
    </div>
    
    <!-- 常用飯友管理對話框 -->
    <div class="friends-dialog" id="friendsDialog">
        <div class="friends-dialog-header">
            <h3><i class="fas fa-users"></i> 管理常用飯友</h3>
            <button class="friends-dialog-close" id="closeFriendsDialog"><i class="fas fa-times"></i></button>
        </div>
        <div class="friends-dialog-body">
            <table class="friends-table" id="friendsTable">
                <thead>
                    <tr>
                        <th width="100%">飯友名稱</th>
                    </tr>
                </thead>
                <tbody id="friendsTableBody">
                    <!-- 會動態填充飯友列表 -->
                </tbody>
            </table>
        </div>
        <div class="friends-dialog-footer">
            <button id="closeDialogBtn" class="cancel-btn"><i class="fas fa-times"></i> 關閉</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize global variables
            let orderCounter = 1;
            let rowCounters = { 1: 1 };
            let activeOrderId = 1;
            let frequentFriends = []; // 存儲常用飯友的數組
            
            // 初始化時從localStorage加載常用飯友
            loadFrequentFriends();
            
            // 設置事件處理程序
            document.querySelector('.add-row-btn[data-order-id="1"]').addEventListener('click', function() {
                addNewRow(1);
            });
            
            // 常用飯友功能
            document.getElementById('addFriendBtn').addEventListener('click', addNewFrequentFriend);
            document.getElementById('manageFriendsBtn').addEventListener('click', showFriendsDialog);
            document.getElementById('closeFriendsDialog').addEventListener('click', hideFriendsDialog);
            document.getElementById('closeDialogBtn').addEventListener('click', hideFriendsDialog);
            document.getElementById('newFriendName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewFrequentFriend();
                }
            });
            
            // 保留添加订单按钮在选项卡区域
            document.getElementById('addOrderTabBtn').addEventListener('click', addNewOrder);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);
            
            // 添加PDF導出功能相關監聽器
            document.getElementById('exportPdfBtn').addEventListener('click', function() {
                overlay.style.display = 'block';
                exportOptions.style.display = 'block';
            });
            
            // Setup tab switching
            setupTabs();
            
            // Setup remove buttons
            setupRemoveButtons();
            
            // 设置输入处理程序
            setupInputHandlers();
            
            // 设置快速金额选项和胶袋费控制
            setupQuickAmountOptions();
            setupBagFeeControls();
            
            // Calculate initially
            calculateAll();
            updateFinalSummary();
            
            // 添加PDF导出相关功能
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const overlay = document.getElementById('overlay');
            const exportOptions = document.getElementById('exportOptions');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const confirmExportBtn = document.getElementById('confirmExportBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // 设置默认文件名为当前日期
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            document.getElementById('exportFilename').value = `費用分攤計算-${dateStr}`;
            
            // 取消导出
            cancelExportBtn.addEventListener('click', function() {
                overlay.style.display = 'none';
                exportOptions.style.display = 'none';
            });
            
            // 确认导出
            confirmExportBtn.addEventListener('click', function() {
                // 隐藏选项对话框
                exportOptions.style.display = 'none';
                
                // 显示加载指示器
                loadingIndicator.style.display = 'block';
                
                // 获取导出选项
                const exportContent = document.getElementById('exportContent').value;
                const pageSize = document.getElementById('pageSize').value;
                const orientation = document.getElementById('orientation').value;
                const filename = document.getElementById('exportFilename').value + '.pdf';
                
                // 在短暂延迟后开始导出（让UI有时间更新）
                setTimeout(function() {
                    generatePDF(exportContent, pageSize, orientation, filename);
                }, 100);
            });
            
            function setupTabs() {
                document.getElementById('orderTabs').addEventListener('click', function(e) {
                    // 如果点击的是删除按钮，则不切换标签
                    if (e.target.classList.contains('order-delete-btn')) {
                        return;
                    }
                    
                    if (e.target.classList.contains('order-tab')) {
                        const orderId = e.target.dataset.orderId;
                        switchTab(orderId);
                    }
                });
            }
            
            function switchTab(orderId) {
                // Remove active class from all tabs and tab contents
                document.querySelectorAll('.order-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.order-tab-content').forEach(content => content.classList.remove('active'));
                
                // Add active class to selected tab and tab content
                document.querySelector(`.order-tab[data-order-id="${orderId}"]`).classList.add('active');
                document.querySelector(`.order-tab-content[data-order-id="${orderId}"]`).classList.add('active');
                
                // Update active order ID
                activeOrderId = orderId;
                
                // 更新摘要区域
                updateSummarySection();
            }
            
            function addNewOrder() {
                orderCounter++;
                rowCounters[orderCounter] = 1;
                
                const newOrderId = orderCounter;
                
                // Create new tab
                const newTab = document.createElement('div');
                newTab.className = 'order-tab';
                newTab.dataset.orderId = newOrderId;
                
                // 基本标签内容
                newTab.innerHTML = `<i class="fas fa-clipboard-list"></i> 訂單 ${newOrderId}`;
                
                // 只为订单2及之后的订单添加删除按钮
                if (newOrderId > 1) {
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'order-delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.setAttribute('title', '刪除此訂單');
                    deleteBtn.dataset.orderId = newOrderId;
                    
                    // 添加删除事件
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // 阻止事件冒泡，防止触发标签切换
                        showDeleteOrderConfirm(newOrderId);
                    });
                    
                    newTab.appendChild(deleteBtn);
                }
                
                // Insert before the + button
                const addButton = document.getElementById('addOrderTabBtn');
                addButton.parentNode.insertBefore(newTab, addButton);
                
                // Setup tab click handler
                newTab.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('order-delete-btn')) {
                        switchTab(newOrderId.toString());
                    }
                });
                
                // Create new tab content
                const orderContents = document.getElementById('orderContents');
                const newContent = document.createElement('div');
                newContent.className = 'order-tab-content';
                newContent.dataset.orderId = newOrderId;
                const headerClass = 'section-header';
                
                // Copy structure from the first order
                newContent.innerHTML = `
                    <!-- 常用飯友區域 -->
                    <div class="frequent-friends">
                        <div class="frequent-friends-title">
                            <h3><i class="fas fa-users"></i> 常用飯友</h3>
                            <div class="frequent-friends-controls">
                                <button class="manage-friends-btn" id="manageFriendsBtn${newOrderId}"><i class="fas fa-cog"></i> 管理飯友</button>
                                <button class="save-friends-btn" id="saveFriendsBtn${newOrderId}"><i class="fas fa-save"></i> 保存飯友</button>
                                <button class="load-friends-btn" id="loadFriendsBtn${newOrderId}"><i class="fas fa-upload"></i> 加載飯友</button>
                            </div>
                        </div>
                        <div class="friend-chips friend-chips-${newOrderId}">
                            <!-- 這裡會動態生成常用飯友按鈕 -->
                        </div>
                        <div class="add-friend-form">
                            <input type="text" id="newFriendName${newOrderId}" placeholder="輸入新飯友名稱">
                            <button id="addFriendBtn${newOrderId}"><i class="fas fa-plus"></i> 添加</button>
                        </div>
                    </div>
                    
                    <div class="calculator-section">
                        <div class="${headerClass}"><i class="fas fa-utensils"></i> 餐點明細及分攤 - 訂單 ${newOrderId}</div>
                        <div class="table-container">
                            <table class="meal-table" id="mealTable${newOrderId}">
                                <thead>
                                    <tr>
                                        <th width="5%">序號</th>
                                        <th width="10%">飯友</th>
                                        <th class="yellow-bg" width="8%">毛付</th>
                                        <th class="yellow-bg" width="8%">外賣盒</th>
                                        <th class="light-blue-bg" width="8%">配送費</th>
                                        <th class="light-blue-bg" width="8%">商家優惠</th>
                                        <th class="light-blue-bg" width="8%">膠袋費</th>
                                        <th class="green-bg" width="8%">獨享優惠</th>
                                        <th class="orange-bg" width="8%">比例</th>
                                        <th width="8%">淨付</th>
                                        <th width="5%">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="meal-table-body" id="mealTableBody${newOrderId}">
                                    <!-- 初始行 -->
                                    <tr class="item-row" data-row-id="1">
                                        <td>01</td>
                                        <td><input type="text" class="person-name" value="" placeholder="姓名"></td>
                                        <td class="yellow-bg"><input type="number" step="0.01" class="meal-cost" value="0" placeholder="餐費"></td>
                                        <td class="yellow-bg"><input type="number" step="0.01" class="box-fee" value="0" placeholder="盒費"></td>
                                        <td class="light-blue-bg"><input type="number" step="0.01" class="delivery-fee" value="0" readonly></td>
                                        <td class="light-blue-bg"><input type="number" step="0.01" class="discount" value="0" readonly></td>
                                        <td class="light-blue-bg"><input type="number" step="0.01" class="bag-fee" value="0" readonly></td>
                                        <td class="green-bg"><input type="number" step="0.01" class="personal-discount" value="" placeholder="個人優惠"></td>
                                        <td class="orange-bg percentage">0%</td>
                                        <td class="net-pay">0.00</td>
                                        <td><span class="remove-btn"><i class="fas fa-trash-alt"></i></span></td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td colspan="2">總計</td>
                                        <td class="yellow-bg total-gross">0.00</td>
                                        <td class="yellow-bg total-box">0.00</td>
                                        <td class="light-blue-bg total-delivery">0.00</td>
                                        <td class="light-blue-bg red-text total-discount">(0.00)</td>
                                        <td class="light-blue-bg total-bag">0.00</td>
                                        <td class="green-bg red-text total-personal-discount">(0.00)</td>
                                        <td class="orange-bg total-percentage">0%</td>
                                        <td class="total-net">0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="add-row">
                            <button class="add-row-btn" data-order-id="${newOrderId}"><i class="fas fa-user-plus"></i> 新增一行</button>
                        </div>
                    </div>
                `;
                
                orderContents.appendChild(newContent);
                
                // Setup the new buttons and handlers
                document.querySelector(`.add-row-btn[data-order-id="${newOrderId}"]`).addEventListener('click', function() {
                    addNewRow(newOrderId);
                });
                
                // Switch to the new tab
                switchTab(newOrderId.toString());
                
                // Setup the new remove buttons
                setupRemoveButtons();
                
                // Setup input handlers for the new order
                setupInputHandlers();
                
                // 設置新訂單的常用飯友功能
                setupFrequentFriendsFeature(newOrderId);
                
                // Update headers in final summary table
                updateFinalSummaryHeaders();
                
                // 自动計算
                calculateAll();
                updateFinalSummary();
                
                // 设置快速金额选项和胶袋费控制
                setupQuickAmountOptions();
                setupBagFeeControls();
            }
            
            function updateFinalSummaryHeaders() {
                // 確保所有訂單的資料都重新計算並更新到總結算表
                for (let i = 1; i <= orderCounter; i++) {
                    // 檢查訂單是否存在
                    if (document.querySelector(`#mealTable${i}`)) {
                        calculateOrderById(i);
                    }
                }
                
                // 更新總結算表，確保刪除訂單後總結算表正確顯示
                updateFinalSummary();
            }
            
            function addNewRow(orderId) {
                // 尋找最小未使用的行號
                const existingRows = document.querySelectorAll(`#mealTableBody${orderId} .item-row`);
                const usedIds = Array.from(existingRows).map(row => parseInt(row.dataset.rowId));
                
                // 從1開始找到第一個未使用的行號
                let newRowId = 1;
                while (usedIds.includes(newRowId)) {
                    newRowId++;
                }
                
                rowCounters[orderId] = Math.max(newRowId, rowCounters[orderId] || 0); // 更新計數器
                
                const tbody = document.getElementById(`mealTableBody${orderId}`);
                const newRow = document.createElement('tr');
                newRow.className = 'item-row';
                newRow.dataset.rowId = newRowId;
                
                const displayNumber = newRowId < 10 ? `0${newRowId}` : newRowId;
                
                // Create the HTML structure for the new row
                newRow.innerHTML = `
                    <td>${displayNumber}</td>
                    <td><input type="text" class="person-name" value="" placeholder="姓名"></td>
                    <td class="yellow-bg"><input type="number" step="0.01" class="meal-cost" value="0" placeholder="餐費"></td>
                    <td class="yellow-bg"><input type="number" step="0.01" class="box-fee" value="0" placeholder="盒費"></td>
                    <td class="light-blue-bg"><input type="number" step="0.01" class="delivery-fee" value="0" readonly></td>
                    <td class="light-blue-bg"><input type="number" step="0.01" class="discount" value="0" readonly></td>
                    <td class="light-blue-bg"><input type="number" step="0.01" class="bag-fee" value="0" readonly></td>
                    <td class="green-bg"><input type="number" step="0.01" class="personal-discount" value="" placeholder="個人優惠"></td>
                    <td class="orange-bg percentage">0%</td>
                    <td class="net-pay">0.00</td>
                    <td><span class="remove-btn"><i class="fas fa-trash-alt"></i></span></td>
                `;
                
                tbody.appendChild(newRow);
                
                // Setup the new remove button
                setupRemoveButtons();
                
                // Setup input handlers for the new row
                setupInputHandlers();
                
                // 自动计算
                calculateOrderById(orderId);
                updateFinalSummary();
            }
            
            function setupRemoveButtons() {
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    // Remove any existing event listeners
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    // Add new event listener
                    newBtn.addEventListener('click', function() {
                        const row = this.closest('tr');
                        const table = this.closest('table');
                        const orderId = table.id.replace('mealTable', '');
                        
                        if (table.querySelectorAll('.item-row').length > 1) {
                            row.remove();
                            
                            // 更新行號顯示（可選，不影響功能）
                            updateRowNumbers(orderId);
                            
                            // 自动触发计算
                            calculateOrderById(orderId);
                            updateFinalSummary();
                        } else {
                            alert('必須至少保留一行');
                        }
                    });
                });
            }
            
            // 更新行號顯示
            function updateRowNumbers(orderId) {
                const rows = document.querySelectorAll(`#mealTableBody${orderId} .item-row`);
                rows.forEach(row => {
                    const rowId = parseInt(row.dataset.rowId);
                    const displayRowNum = rowId < 10 ? `0${rowId}` : rowId;
                    row.querySelector('td:first-child').textContent = displayRowNum;
                });
            }
            
            function setupInputHandlers() {
                // Remove any existing event listeners (by cloning and replacing)
                document.querySelectorAll('.meal-cost, .box-fee, .personal-discount').forEach(input => {
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                });
                
                document.querySelectorAll('.delivery-fee-total, .merchant-discount, .bag-fee-total').forEach(input => {
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                });
                
                // Add new event listeners with automatic calculation
                document.querySelectorAll('.meal-cost, .box-fee, .personal-discount').forEach(input => {
                    input.addEventListener('input', function() {
                        const table = this.closest('table');
                        const orderId = table.id.replace('mealTable', '');
                        calculateOrderById(orderId);
                        updateFinalSummary();
                    });
                });
                
                document.querySelectorAll('.delivery-fee-total, .merchant-discount, .bag-fee-total').forEach(input => {
                    input.addEventListener('input', function() {
                        const table = this.closest('table');
                        const orderId = table.id.replace('expenseTable', '');
                        calculateOrderById(orderId);
                        updateFinalSummary();
                    });
                });
                
                // 添加人员姓名输入变化时自动更新结算表
                document.querySelectorAll('.person-name').forEach(input => {
                    input.addEventListener('input', function() {
                        updateFinalSummary();
                    });
                });
                
                // 重设快速金额选项和胶袋费控制
                setupQuickAmountOptions();
                setupBagFeeControls();
            }
            
            // 设置快速金额选项的函数
            function setupQuickAmountOptions() {
                // 为每个快速金额选项组设置点击事件
                document.querySelectorAll('.quick-amount-options').forEach(optionsGroup => {
                    const merchantDiscountInput = optionsGroup.closest('tr').querySelector('.merchant-discount');
                    const currentValue = parseFloat(merchantDiscountInput.value) || 0;
                    
                    // 找到与当前值匹配的按钮并标记为活跃
                    optionsGroup.querySelectorAll('.quick-amount').forEach(btn => {
                        // 移除所有活跃状态
                        btn.classList.remove('active');
                        
                        // 检查是否与当前输入值匹配
                        const btnAmount = parseFloat(btn.dataset.amount);
                        if (btnAmount === currentValue) {
                            btn.classList.add('active');
                        }
                        
                        // 移除现有事件监听器
                        const newBtn = btn.cloneNode(true);
                        btn.parentNode.replaceChild(newBtn, btn);
                        
                        // 添加新事件监听器
                        newBtn.addEventListener('click', function() {
                            const amount = parseFloat(this.dataset.amount);
                            
                            // 移除所有按钮的活跃状态
                            this.closest('.quick-amount-options').querySelectorAll('.quick-amount').forEach(b => {
                                b.classList.remove('active');
                            });
                            
                            // 添加当前按钮的活跃状态
                            this.classList.add('active');
                            
                            // 更新输入框的值
                            const input = this.closest('tr').querySelector('.merchant-discount');
                            input.value = amount;
                            
                            // 触发计算
                            const table = this.closest('table');
                            const orderId = table.id.replace('expenseTable', '');
                            calculateOrderById(orderId);
                            updateFinalSummary();
                        });
                    });
                });
                
                // 为商家优惠输入框添加事件监听器，当值改变时更新按钮的高亮状态
                document.querySelectorAll('.merchant-discount').forEach(input => {
                    // 克隆并替换以移除旧事件监听器
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                    
                    // 添加新事件监听器
                    newInput.addEventListener('input', function() {
                        const currentValue = parseFloat(this.value) || 0;
                        const optionsGroup = this.closest('tr').querySelector('.quick-amount-options');
                        
                        // 更新按钮高亮状态
                        optionsGroup.querySelectorAll('.quick-amount').forEach(btn => {
                            btn.classList.remove('active');
                            
                            const btnAmount = parseFloat(btn.dataset.amount);
                            if (btnAmount === currentValue) {
                                btn.classList.add('active');
                            }
                        });
                        
                        // 触发计算
                        const table = this.closest('table');
                        const orderId = table.id.replace('expenseTable', '');
                        calculateOrderById(orderId);
                        updateFinalSummary();
                    });
                });
            }
            
            // 设置胶袋费加减按钮的函数
            function setupBagFeeControls() {
                // 设置新设计的减少按钮
                document.querySelectorAll('.bag-decrease-modern').forEach(btn => {
                    // 移除现有事件监听器
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    // 添加新事件监听器
                    newBtn.addEventListener('click', function() {
                        // 获取对应的隐藏输入框
                        const container = this.closest('.bag-fee-container');
                        const bagFeeControls = container.parentNode.querySelector('.bag-fee-controls');
                        const input = bagFeeControls.querySelector('.bag-fee-total');
                        const countDisplay = container.querySelector('.bag-fee-count');
                        
                        let value = parseInt(input.value) || 0;
                        
                        if (value > 0) {
                            value--;
                            // 更新隐藏输入框的值
                            input.value = value;
                            // 更新显示的计数
                            countDisplay.textContent = value;
                            
                            // 加入动画效果
                            this.classList.add('clicked');
                            setTimeout(() => {
                                this.classList.remove('clicked');
                            }, 200);
                            
                            // 触发计算
                            const table = this.closest('table');
                            const orderId = table.id.replace('expenseTable', '');
                            calculateOrderById(orderId);
                            updateFinalSummary();
                            
                            // 显示提示信息
                            showModernBagFeeTooltip(container, `减少 1 个膠袋 (-1元)`);
                        }
                    });
                });
                
                // 设置新设计的增加按钮
                document.querySelectorAll('.bag-increase-modern').forEach(btn => {
                    // 移除现有事件监听器
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    // 添加新事件监听器
                    newBtn.addEventListener('click', function() {
                        // 获取对应的隐藏输入框
                        const container = this.closest('.bag-fee-container');
                        const bagFeeControls = container.parentNode.querySelector('.bag-fee-controls');
                        const input = bagFeeControls.querySelector('.bag-fee-total');
                        const countDisplay = container.querySelector('.bag-fee-count');
                        
                        let value = parseInt(input.value) || 0;
                        
                        value++;
                        // 更新隐藏输入框的值
                        input.value = value;
                        // 更新显示的计数
                        countDisplay.textContent = value;
                        
                        // 加入动画效果
                        this.classList.add('clicked');
                        setTimeout(() => {
                            this.classList.remove('clicked');
                        }, 200);
                        
                        // 触发计算
                        const table = this.closest('table');
                        const orderId = table.id.replace('expenseTable', '');
                        calculateOrderById(orderId);
                        updateFinalSummary();
                        
                        // 显示提示信息
                        showModernBagFeeTooltip(container, `添加 1 個膠袋 (+1元)`);
                    });
                });
                
                // 保留旧的控制器事件处理（虽然不可见，但数据仍然需要保持一致性）
                document.querySelectorAll('.bag-decrease').forEach(btn => {
                    // 移除现有事件监听器
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    // 添加新事件监听器
                    newBtn.addEventListener('click', function() {
                        const input = this.parentNode.querySelector('.bag-fee-total');
                        const row = this.closest('tr');
                        const container = row.querySelector('.bag-fee-container');
                        const countDisplay = container.querySelector('.bag-fee-count');
                        
                        let value = parseInt(input.value) || 0;
                        
                        if (value > 0) {
                            value--;
                            input.value = value;
                            countDisplay.textContent = value;
                            
                            // 触发计算
                            const table = this.closest('table');
                            const orderId = table.id.replace('expenseTable', '');
                            calculateOrderById(orderId);
                            updateFinalSummary();
                        }
                    });
                });
                
                document.querySelectorAll('.bag-increase').forEach(btn => {
                    // 移除现有事件监听器
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    // 添加新事件监听器
                    newBtn.addEventListener('click', function() {
                        const input = this.parentNode.querySelector('.bag-fee-total');
                        const row = this.closest('tr');
                        const container = row.querySelector('.bag-fee-container');
                        const countDisplay = container.querySelector('.bag-fee-count');
                        
                        let value = parseInt(input.value) || 0;
                        
                        value++;
                        input.value = value;
                        countDisplay.textContent = value;
                        
                        // 触发计算
                        const table = this.closest('table');
                        const orderId = table.id.replace('expenseTable', '');
                        calculateOrderById(orderId);
                        updateFinalSummary();
                    });
                });
                
                // 初始化计数显示
                document.querySelectorAll('.bag-fee-total').forEach(input => {
                    const row = input.closest('tr');
                    const container = row.querySelector('.bag-fee-container');
                    if (container) {
                        const countDisplay = container.querySelector('.bag-fee-count');
                        countDisplay.textContent = input.value;
                    }
                });
            }
            
            // 现代风格的胶袋费提示函数
            function showModernBagFeeTooltip(container, message) {
                let tooltip = document.createElement('div');
                tooltip.className = 'modern-tooltip';
                tooltip.textContent = message;
                tooltip.style.position = 'absolute';
                tooltip.style.top = '-40px';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.background = 'rgba(52, 152, 219, 0.9)';
                tooltip.style.color = 'white';
                tooltip.style.padding = '8px 15px';
                tooltip.style.borderRadius = '20px';
                tooltip.style.fontSize = '14px';
                tooltip.style.fontWeight = 'bold';
                tooltip.style.boxShadow = '0 3px 10px rgba(0,0,0,0.1)';
                tooltip.style.zIndex = '100';
                tooltip.style.opacity = '0';
                tooltip.style.transition = 'all 0.3s';
                tooltip.style.whiteSpace = 'nowrap';
                tooltip.style.pointerEvents = 'none';
                
                // 添加小三角形
                tooltip.style.setProperty('--arrow-color', 'rgba(52, 152, 219, 0.9)');
                tooltip.style.setProperty('--arrow-size', '8px');
                
                container.appendChild(tooltip);
                
                // 动画显示
                setTimeout(() => {
                    tooltip.style.opacity = '1';
                    tooltip.style.top = '-50px';
                }, 10);
                
                // 2秒后隐藏
                setTimeout(() => {
                    tooltip.style.opacity = '0';
                    tooltip.style.top = '-40px';
                    setTimeout(() => {
                        tooltip.remove();
                    }, 300);
                }, 2000);
            }
            
            function calculateAll() {
                // Calculate each order
                for (let i = 1; i <= orderCounter; i++) {
                    calculateOrderById(i);
                }
                
                // Update final summary
                updateFinalSummary();
            }
            
            function calculateOrderById(orderId) {
                // Get all rows for this order
                const rows = document.querySelectorAll(`#mealTableBody${orderId} .item-row`);
                const numPeople = rows.length;
                
                // Get total expenses from input for this order
                const deliveryTotal = parseFloat(document.querySelector(`#expenseTable${orderId} .delivery-fee-total`).value) || 0;
                const discountTotal = parseFloat(document.querySelector(`#expenseTable${orderId} .merchant-discount`).value) || 0;
                const bagTotal = parseFloat(document.querySelector(`#expenseTable${orderId} .bag-fee-total`).value) || 0;
                
                // 首先计算总毛付金额，用于计算每人的费用比例
                let totalMealAndBoxCost = 0;
                rows.forEach(row => {
                    const mealCost = parseFloat(row.querySelector('.meal-cost').value) || 0;
                    const boxFee = parseFloat(row.querySelector('.box-fee').value) || 0;
                    totalMealAndBoxCost += (mealCost + boxFee);
                });
                
                // Initialize totals
                let totalGross = 0;
                let totalBox = 0;
                let totalDelivery = 0;
                let totalDiscount = 0;
                let totalPersonalDiscount = 0;
                let totalBag = 0;
                let totalNet = 0;
                
                // Update each row with calculated values
                rows.forEach((row, index) => {
                    // Get meal cost and box fee (these remain user input)
                    const mealCost = parseFloat(row.querySelector('.meal-cost').value) || 0;
                    const boxFee = parseFloat(row.querySelector('.box-fee').value) || 0;
                    
                    // 计算个人所占比例 - 使用餐费+外賣盒费计算比例
                    const personRatio = totalMealAndBoxCost > 0 ? (mealCost + boxFee) / totalMealAndBoxCost : 0;
                    
                    // 按比例分配费用
                    const deliveryShare = deliveryTotal * personRatio;
                    const discountShare = discountTotal * personRatio;
                    const bagShare = bagTotal * personRatio;
                    
                    // 获取独享优惠 - 确保只有用户实际输入的值才被使用
                    const personalDiscountInput = row.querySelector('.personal-discount');
                    // 只有在用户明确输入了值时才使用它
                    const personalDiscount = personalDiscountInput.value !== "" ? (parseFloat(personalDiscountInput.value) || 0) : 0;
                    
                    // Set calculated values
                    row.querySelector('.delivery-fee').value = deliveryShare.toFixed(2);
                    row.querySelector('.discount').value = discountShare.toFixed(2);
                    row.querySelector('.bag-fee').value = bagShare.toFixed(2);
                    
                    // Calculate row totals
                    const gross = mealCost;
                    const net = mealCost + boxFee + deliveryShare - discountShare - personalDiscount + bagShare;
                    
                    // Update totals
                    totalGross += gross;
                    totalBox += boxFee;
                    totalDelivery += deliveryShare;
                    totalDiscount += discountShare;
                    totalPersonalDiscount += personalDiscount;
                    totalBag += bagShare;
                    totalNet += net;
                    
                    // Calculate percentage
                    const percentage = totalMealAndBoxCost > 0 ? ((mealCost + boxFee) / totalMealAndBoxCost * 100) : 0;
                    row.querySelector('.percentage').textContent = `${percentage.toFixed(1)}%`;
                    row.querySelector('.net-pay').textContent = net.toFixed(2);
                });
                
                // Update order totals
                const table = document.getElementById(`mealTable${orderId}`);
                table.querySelector('.total-gross').textContent = totalGross.toFixed(2);
                table.querySelector('.total-box').textContent = totalBox.toFixed(2);
                table.querySelector('.total-delivery').textContent = totalDelivery.toFixed(2);
                table.querySelector('.total-discount').textContent = `(${totalDiscount.toFixed(2)})`;
                table.querySelector('.total-personal-discount').textContent = `(${totalPersonalDiscount.toFixed(2)})`;
                table.querySelector('.total-bag').textContent = totalBag.toFixed(2);
                table.querySelector('.total-net').textContent = totalNet.toFixed(2);
                
                // 更新总计行的比例为100%
                table.querySelector('.total-percentage').textContent = "100.0%";
                
                // If this is the active order, update summary section
                if (parseInt(activeOrderId) === parseInt(orderId)) {
                    updateSummarySection();
                }
                
                return totalNet;
            }
            
            // 新增函数：更新摘要区域显示所有订单的总计
            function updateSummarySection() {
                // 计算所有订单的总计
                let allOrdersTotalGross = 0;
                let allOrdersTotalBox = 0;
                let allOrdersTotalDelivery = 0;
                let allOrdersTotalDiscount = 0;
                let allOrdersTotalPersonalDiscount = 0;
                let allOrdersTotalBag = 0;
                let allOrdersTotalNet = 0;
                let allOrdersTotalPeople = 0;
                
                for (let i = 1; i <= orderCounter; i++) {
                    // 检查订单是否存在
                    if (!document.querySelector(`#mealTable${i}`)) continue;
                    
                    const table = document.querySelector(`#mealTable${i}`);
                    allOrdersTotalGross += parseFloat(table.querySelector('.total-gross').textContent) || 0;
                    allOrdersTotalBox += parseFloat(table.querySelector('.total-box').textContent) || 0;
                    allOrdersTotalDelivery += parseFloat(table.querySelector('.total-delivery').textContent) || 0;
                    allOrdersTotalDiscount += parseFloat(table.querySelector('.total-discount').textContent.replace(/[()]/g, '')) || 0;
                    allOrdersTotalPersonalDiscount += parseFloat(table.querySelector('.total-personal-discount').textContent.replace(/[()]/g, '')) || 0;
                    allOrdersTotalBag += parseFloat(table.querySelector('.total-bag').textContent) || 0;
                    allOrdersTotalNet += parseFloat(table.querySelector('.total-net').textContent) || 0;
                    
                    // 计算人数
                    allOrdersTotalPeople += document.querySelectorAll(`#mealTableBody${i} .item-row`).length;
                }
                
                // 更新摘要区域显示所有订单的总计
                document.getElementById('summaryGross').textContent = allOrdersTotalGross.toFixed(2);
                document.getElementById('summaryDiscount').textContent = `(${(allOrdersTotalDiscount + allOrdersTotalPersonalDiscount).toFixed(2)})`;
                document.getElementById('summaryNet').textContent = allOrdersTotalNet.toFixed(2);
                document.getElementById('summaryPeople').textContent = allOrdersTotalPeople;
                document.getElementById('summaryFood').textContent = allOrdersTotalGross.toFixed(2);
                document.getElementById('summaryBox').textContent = allOrdersTotalBox.toFixed(2);
                document.getElementById('summaryDelivery').textContent = allOrdersTotalDelivery.toFixed(2);
                document.getElementById('summaryBag').textContent = allOrdersTotalBag.toFixed(2);
            }
            
            function updateFinalSummary() {
                // Get all unique person names across all orders
                const allPersons = new Map(); // Using Map to preserve order
                
                // Collect all person names and initialize data structure
                for (let i = 1; i <= orderCounter; i++) {
                    // 檢查該訂單是否存在
                    if (!document.querySelector(`#mealTableBody${i}`)) continue;
                    
                    const rows = document.querySelectorAll(`#mealTableBody${i} .item-row`);
                    
                    rows.forEach(row => {
                        const name = row.querySelector('.person-name').value.trim();
                        if (name && !allPersons.has(name)) {
                            allPersons.set(name, {
                                totalGross: 0,
                                totalBox: 0,
                                totalDelivery: 0,
                                totalDiscount: 0,
                                totalPersonalDiscount: 0,
                                totalBag: 0,
                                totalNet: 0,
                                totalPercentage: 0
                            });
                        }
                    });
                }
                
                // Collect amounts and details for each person from each order
                for (let i = 1; i <= orderCounter; i++) {
                    // 檢查該訂單是否存在
                    if (!document.querySelector(`#mealTableBody${i}`)) continue;
                    
                    const rows = document.querySelectorAll(`#mealTableBody${i} .item-row`);
                    
                    rows.forEach(row => {
                        const name = row.querySelector('.person-name').value.trim();
                        if (name) {
                            const amount = parseFloat(row.querySelector('.net-pay').textContent) || 0;
                            const mealCost = parseFloat(row.querySelector('.meal-cost').value) || 0;
                            const boxFee = parseFloat(row.querySelector('.box-fee').value) || 0;
                            const deliveryFee = parseFloat(row.querySelector('.delivery-fee').value) || 0;
                            const discount = parseFloat(row.querySelector('.discount').value) || 0;
                            const personalDiscount = parseFloat(row.querySelector('.personal-discount').value) || 0;
                            const bagFee = parseFloat(row.querySelector('.bag-fee').value) || 0;
                            
                            const personData = allPersons.get(name);
                            personData.totalGross += mealCost; // 只将餐费计入总毛付金额
                            personData.totalBox += boxFee;
                            personData.totalDelivery += deliveryFee;
                            personData.totalDiscount += discount;
                            personData.totalPersonalDiscount += personalDiscount;
                            personData.totalBag += bagFee;
                            personData.totalNet += amount;
                            // 百分比计算基于总金额
                            personData.totalPercentage = (personData.totalNet / getTotalNetAcrossAllOrders() * 100);
                            
                            allPersons.set(name, personData);
                        }
                    });
                }
                
                // Generate the final summary table
                const tbody = document.getElementById('finalSummaryTableBody');
                tbody.innerHTML = '';
                
                let index = 1;
                let grandTotal = 0;
                let finalTotalGross = 0;
                let finalTotalBox = 0;
                let finalTotalDelivery = 0;
                let finalTotalDiscount = 0;
                let finalTotalPersonalDiscount = 0;
                let finalTotalBag = 0;
                let finalTotalNet = 0;
                
                allPersons.forEach((data, name) => {
                    const row = document.createElement('tr');
                    const displayIndex = index < 10 ? `0${index}` : index;
                    
                    // 确保个人独享优惠正确显示
                    // 如果用户未输入个人独享优惠，则显示0.00
                    const personalDiscountValue = data.totalPersonalDiscount > 0 ? data.totalPersonalDiscount.toFixed(2) : "0.00";
                    
                    let rowHTML = `
                        <td>${displayIndex}</td>
                        <td>${name}</td>
                        <td class="yellow-bg">${data.totalGross.toFixed(2)}</td>
                        <td class="yellow-bg">${data.totalBox.toFixed(2)}</td>
                        <td class="light-blue-bg">${data.totalDelivery.toFixed(2)}</td>
                        <td class="light-blue-bg">${data.totalDiscount.toFixed(2)}</td>
                        <td class="light-blue-bg">${personalDiscountValue}</td>
                        <td class="light-blue-bg">${data.totalBag.toFixed(2)}</td>
                        <td class="orange-bg">${data.totalPercentage.toFixed(1)}%</td>
                        <td>${data.totalNet.toFixed(2)}</td>
                        <td class="grand-total-column">${data.totalNet.toFixed(2)}</td>
                        <td><span class="remove-btn person-delete-btn" data-name="${name}"><i class="fas fa-trash-alt"></i></span></td>
                    `;
                    
                    row.innerHTML = rowHTML;
                    tbody.appendChild(row);
                    
                    // Update totals
                    finalTotalGross += data.totalGross;
                    finalTotalBox += data.totalBox;
                    finalTotalDelivery += data.totalDelivery;
                    finalTotalDiscount += data.totalDiscount;
                    finalTotalPersonalDiscount += data.totalPersonalDiscount;
                    finalTotalBag += data.totalBag;
                    finalTotalNet += data.totalNet;
                    grandTotal += data.totalNet;
                    
                    index++;
                });
                
                // Update footer totals
                document.getElementById('finalTotalGross').textContent = finalTotalGross.toFixed(2);
                document.getElementById('finalTotalBox').textContent = finalTotalBox.toFixed(2);
                document.getElementById('finalTotalDelivery').textContent = finalTotalDelivery.toFixed(2);
                document.getElementById('finalTotalDiscount').textContent = finalTotalDiscount.toFixed(2);
                document.getElementById('finalTotalPersonalDiscount').textContent = finalTotalPersonalDiscount > 0 ? finalTotalPersonalDiscount.toFixed(2) : "0.00";
                document.getElementById('finalTotalBag').textContent = finalTotalBag.toFixed(2);
                document.getElementById('finalTotalPercentage').textContent = '100%';
                document.getElementById('finalTotalNet').textContent = finalTotalNet.toFixed(2);
                
                // Update grand total
                document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
                
                // 更新总人数（所有订单中不重复的人数）
                document.getElementById('summaryPeople').textContent = allPersons.size;
                
                // 同步更新摘要部分
                updateSummarySection();
            }
            
            function getTotalNetAcrossAllOrders() {
                let total = 0;
                for (let i = 1; i <= orderCounter; i++) {
                    // 检查订单是否存在
                    if (!document.querySelector(`#mealTable${i}`)) continue;
                    
                    const netElement = document.querySelector(`#mealTable${i} .total-net`);
                    if (netElement) {
                        total += parseFloat(netElement.textContent) || 0;
                    }
                }
                return total;
            }
            
            // 重新添加函数用于计算所有订单的总毛付
            function getTotalGrossAcrossAllOrders() {
                let total = 0;
                for (let i = 1; i <= orderCounter; i++) {
                    // 检查订单是否存在
                    if (!document.querySelector(`#mealTable${i}`)) continue;
                    
                    const grossElement = document.querySelector(`#mealTable${i} .total-gross`);
                    if (grossElement) {
                        total += parseFloat(grossElement.textContent) || 0;
                    }
                }
                return total;
            }
            
            function clearAllData() {
                if (confirm('確定要清除所有數據嗎？此操作無法恢復。')) {
                    // Reset order counter
                    orderCounter = 1;
                    rowCounters = { 1: 1 };
                    activeOrderId = 1;
                    
                    // Clear tabs (keep first tab only)
                    const orderTabs = document.getElementById('orderTabs');
                    while (orderTabs.children.length > 2) {
                        orderTabs.removeChild(orderTabs.children[1]); // Remove second tab (after first tab, before + button)
                    }
                    
                    // Clear order contents (keep first order only)
                    const orderContents = document.getElementById('orderContents');
                    while (orderContents.children.length > 1) {
                        orderContents.removeChild(orderContents.lastChild);
                    }
                    
                    // Reset first order
                    document.querySelectorAll('.order-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.order-tab-content').forEach(content => content.classList.remove('active'));
                    document.querySelector('.order-tab[data-order-id="1"]').classList.add('active');
                    document.querySelector('.order-tab-content[data-order-id="1"]').classList.add('active');
                    
                    // Clear rows in first order (keep first row)
                    const tbody = document.getElementById('mealTableBody1');
                    while (tbody.children.length > 1) {
                        tbody.removeChild(tbody.lastChild);
                    }
                    
                    // Reset the first row
                    const firstRow = tbody.firstChild;
                    firstRow.querySelector('.person-name').value = '';
                    firstRow.querySelector('.meal-cost').value = '0';
                    firstRow.querySelector('.box-fee').value = '0';
                    firstRow.querySelector('.delivery-fee').value = '0';
                    firstRow.querySelector('.discount').value = '0';
                    firstRow.querySelector('.personal-discount').value = '';
                    firstRow.querySelector('.bag-fee').value = '0';
                    
                    // Reset expense table
                    document.querySelector('#expenseTable1 .delivery-fee-total').value = '0';
                    document.querySelector('#expenseTable1 .merchant-discount').value = '0';
                    document.querySelector('#expenseTable1 .bag-fee-total').value = '0';
                    
                    // Clear final summary table
                    document.getElementById('finalSummaryTableBody').innerHTML = '';
                    
                    // Update final summary headers
                    updateFinalSummaryHeaders();
                    
                    // Recalculate
                    calculateAll();
                }
            }
            
            function saveData() {
                // In a real app, this would save to localStorage or server
                alert('數據已保存！在實際應用中，這會將數據保存到瀏覽器或伺服器。');
            }
            
            function loadData() {
                // In a real app, this would load from localStorage or server
                alert('載入數據！在實際應用中，這會從瀏覽器或伺服器加載保存的數據。');
            }
            
            function addSampleData() {
                // Add data to first order
                const firstOrder = document.querySelector('#mealTableBody1 .item-row');
                firstOrder.querySelector('.person-name').value = 'hou';
                firstOrder.querySelector('.meal-cost').value = '40.00';
                firstOrder.querySelector('.box-fee').value = '2.00';
                
                // Set expense data for first order
                document.querySelector('#expenseTable1 .delivery-fee-total').value = '4.00';
                document.querySelector('#expenseTable1 .merchant-discount').value = '20.00';
                document.querySelector('#expenseTable1 .bag-fee-total').value = '2.00';
                
                // Add more rows to first order
                addNewRow(1);
                const secondRow = document.querySelectorAll('#mealTableBody1 .item-row')[1];
                secondRow.querySelector('.person-name').value = 'julia';
                secondRow.querySelector('.meal-cost').value = '40.00';
                secondRow.querySelector('.box-fee').value = '2.00';
                
                addNewRow(1);
                const thirdRow = document.querySelectorAll('#mealTableBody1 .item-row')[2];
                thirdRow.querySelector('.person-name').value = 'Karen';
                thirdRow.querySelector('.meal-cost').value = '40.00';
                thirdRow.querySelector('.box-fee').value = '2.00';
                
                // Add second order
                addNewOrder();
                const firstRow2 = document.querySelector('#mealTableBody2 .item-row');
                firstRow2.querySelector('.person-name').value = 'GARY';
                firstRow2.querySelector('.meal-cost').value = '15.00';
                firstRow2.querySelector('.box-fee').value = '1.00';
                
                // Set expense data for second order
                document.querySelector('#expenseTable2 .delivery-fee-total').value = '1.00';
                document.querySelector('#expenseTable2 .merchant-discount').value = '30.00';
                document.querySelector('#expenseTable2 .bag-fee-total').value = '1.00';
                
                // Add more rows to second order
                addNewRow(2);
                const secondRow2 = document.querySelectorAll('#mealTableBody2 .item-row')[1];
                secondRow2.querySelector('.person-name').value = 'JUANE';
                secondRow2.querySelector('.meal-cost').value = '15.00';
                secondRow2.querySelector('.box-fee').value = '1.00';
                
                addNewRow(2);
                const thirdRow2 = document.querySelectorAll('#mealTableBody2 .item-row')[2];
                thirdRow2.querySelector('.person-name').value = 'HOU';
                thirdRow2.querySelector('.meal-cost').value = '15.00';
                thirdRow2.querySelector('.box-fee').value = '1.00';
                
                // Calculate and update
                calculateAll();
                updateFinalSummary();
                
                // Switch back to first tab
                switchTab('1');
            }
            
            // 生成PDF
            function generatePDF(exportContent, pageSize, orientation, filename) {
                const { jsPDF } = window.jspdf;
                
                // 初始化jsPDF
                const pdf = new jsPDF({
                    orientation: orientation,
                    unit: 'mm',
                    format: pageSize
                });
                
                // 创建一个容器来合成整个PDF内容
                const pdfContent = document.createElement('div');
                pdfContent.style.position = 'absolute';
                pdfContent.style.left = '-9999px';
                pdfContent.style.width = orientation === 'landscape' ? '1100px' : '800px';
                document.body.appendChild(pdfContent);
                
                // 创建样式容器以保留原始样式
                const styleContainer = document.createElement('div');
                styleContainer.style.padding = '20px';
                styleContainer.style.backgroundColor = 'white';
                styleContainer.style.fontFamily = 'Arial, "Microsoft JhengHei", sans-serif';
                
                // 创建标题
                const mainTitle = document.createElement('h1');
                mainTitle.style.textAlign = 'center';
                mainTitle.style.margin = '10px 0 20px 0';
                mainTitle.style.color = '#4682B4';
                mainTitle.style.fontSize = '24px';
                mainTitle.textContent = 'CJT體重增加費用分攤計算';
                styleContainer.appendChild(mainTitle);
                
                // 添加订单摘要部分
                if (exportContent === 'all' || exportContent === 'summary') {
                    // 创建订单摘要区域
                    const summarySection = document.createElement('div');
                    summarySection.style.marginBottom = '20px';
                    
                    // 添加摘要标题
                    const summaryTitle = document.createElement('h2');
                    summaryTitle.style.color = '#5cb85c';
                    summaryTitle.style.fontSize = '18px';
                    summaryTitle.style.marginBottom = '10px';
                    summaryTitle.style.borderBottom = '2px solid #5cb85c';
                    summaryTitle.style.paddingBottom = '5px';
                    summaryTitle.textContent = '訂單摘要';
                    summarySection.appendChild(summaryTitle);
                    
                    // 创建摘要表格
                    const summaryTable = document.createElement('table');
                    summaryTable.style.width = '100%';
                    summaryTable.style.borderCollapse = 'collapse';
                    summaryTable.style.marginBottom = '20px';
                    summaryTable.style.border = '1px solid #ddd';
                    
                    // 获取原始数据
                    const grossTotal = document.getElementById('summaryGross').textContent;
                    const discountTotal = document.getElementById('summaryDiscount').textContent;
                    const netTotal = document.getElementById('summaryNet').textContent;
                    const peopleCount = document.getElementById('summaryPeople').textContent;
                    const foodTotal = document.getElementById('summaryFood').textContent;
                    const boxTotal = document.getElementById('summaryBox').textContent;
                    const deliveryTotal = document.getElementById('summaryDelivery').textContent;
                    const bagTotal = document.getElementById('summaryBag').textContent;
                    
                    summaryTable.innerHTML = `
                        <tr>
                            <th style="padding: 8px; border: 1px solid #ddd; background-color: #f8f8f8; width: 20%;">項目</th>
                            <th style="padding: 8px; border: 1px solid #ddd; background-color: #f8f8f8; width: 30%;">金額</th>
                            <th style="padding: 8px; border: 1px solid #ddd; background-color: #f8f8f8; width: 20%;">項目</th>
                            <th style="padding: 8px; border: 1px solid #ddd; background-color: #f8f8f8; width: 30%;">金額</th>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">總毛額</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${grossTotal}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">餐點總額</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${foodTotal}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">總優惠</td>
                            <td style="padding: 8px; border: 1px solid #ddd; color: #e74c3c;">${discountTotal}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">外賣盒費</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${boxTotal}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">總淨額</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${netTotal}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">配送費</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${deliveryTotal}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">人數</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${peopleCount}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">膠袋費</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${bagTotal}</td>
                        </tr>
                    `;
                    
                    summarySection.appendChild(summaryTable);
                    styleContainer.appendChild(summarySection);
                }
                
                // 添加总结算表
                if (exportContent === 'all' || exportContent === 'summary') {
                    const finalTable = document.querySelector('#finalSummaryTable').cloneNode(true);
                    
                    // 创建总结算区域
                    const finalSection = document.createElement('div');
                    finalSection.style.marginTop = '20px';
                    
                    // 添加结算标题
                    const finalTitle = document.createElement('h2');
                    finalTitle.style.color = '#5cb85c';
                    finalTitle.style.fontSize = '18px';
                    finalTitle.style.marginBottom = '10px';
                    finalTitle.style.borderBottom = '2px solid #5cb85c';
                    finalTitle.style.paddingBottom = '5px';
                    finalTitle.textContent = '總結算表';
                    finalSection.appendChild(finalTitle);
                    
                    // 格式化总结算表
                    const newFinalTable = document.createElement('table');
                    newFinalTable.style.width = '100%';
                    newFinalTable.style.borderCollapse = 'collapse';
                    newFinalTable.style.border = '1px solid #ddd';
                    
                    // 复制表头
                    const thead = finalTable.querySelector('thead');
                    if (thead) {
                        const newThead = document.createElement('thead');
                        
                        // 处理第一行表头（如果有）
                        const headerRow1 = thead.querySelector('tr:first-child');
                        if (headerRow1) {
                            const newHeaderRow1 = document.createElement('tr');
                            headerRow1.querySelectorAll('th').forEach(th => {
                                const newTh = document.createElement('th');
                                newTh.innerHTML = th.innerHTML;
                                newTh.style.padding = '8px';
                                newTh.style.border = '1px solid #ddd';
                                newTh.style.backgroundColor = '#f2f9f2';
                                newTh.style.textAlign = 'center';
                                newTh.style.fontWeight = 'bold';
                                if (th.rowSpan) newTh.rowSpan = th.rowSpan;
                                if (th.colSpan) newTh.colSpan = th.colSpan;
                                
                                if (th.classList.contains('order-group-header')) {
                                    newTh.style.backgroundColor = '#e8f4f8';
                                    newTh.style.borderBottom = '1px solid #bbd8e7';
                                }
                                
                                if (th.classList.contains('grand-total-column')) {
                                    newTh.style.backgroundColor = '#d0e9d0';
                                    newTh.style.borderLeft = '2px solid #5cb85c';
                                }
                                
                                newHeaderRow1.appendChild(newTh);
                            });
                            newThead.appendChild(newHeaderRow1);
                        }
                        
                        // 处理第二行表头（如果有）
                        const headerRow2 = thead.querySelector('tr:nth-child(2)');
                        if (headerRow2) {
                            const newHeaderRow2 = document.createElement('tr');
                            headerRow2.querySelectorAll('th').forEach(th => {
                                const newTh = document.createElement('th');
                                newTh.innerHTML = th.innerHTML;
                                newTh.style.padding = '8px';
                                newTh.style.border = '1px solid #ddd';
                                newTh.style.backgroundColor = '#f2f9f2';
                                newTh.style.textAlign = 'center';
                                newTh.style.fontWeight = 'bold';
                                
                                if (th.classList.contains('yellow-bg')) {
                                    newTh.style.backgroundColor = '#FFFD9A';
                                } else if (th.classList.contains('light-blue-bg')) {
                                    newTh.style.backgroundColor = '#B8E2F2';
                                } else if (th.classList.contains('orange-bg')) {
                                    newTh.style.backgroundColor = '#FFC87C';
                                }
                                
                                newHeaderRow2.appendChild(newTh);
                            });
                            newThead.appendChild(newHeaderRow2);
                        }
                        
                        newFinalTable.appendChild(newThead);
                    }
                    
                    // 复制表体
                    const tbody = finalTable.querySelector('tbody');
                    if (tbody) {
                        const newTbody = document.createElement('tbody');
                        const rows = tbody.querySelectorAll('tr');
                        
                        rows.forEach((row, rowIndex) => {
                            const newRow = document.createElement('tr');
                            // 设置交替行的背景色
                            if (rowIndex % 2 === 1) {
                                newRow.style.backgroundColor = '#f9f9f9';
                            }
                            
                            row.querySelectorAll('td').forEach(cell => {
                                const newCell = document.createElement('td');
                                newCell.innerHTML = cell.innerHTML;
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.classList.contains('yellow-bg')) {
                                    newCell.style.backgroundColor = '#FFFD9A';
                                } else if (cell.classList.contains('light-blue-bg')) {
                                    newCell.style.backgroundColor = '#B8E2F2';
                                } else if (cell.classList.contains('orange-bg')) {
                                    newCell.style.backgroundColor = '#FFC87C';
                                } else if (cell.classList.contains('grand-total-column')) {
                                    newCell.style.backgroundColor = '#e9f7e9';
                                    newCell.style.borderLeft = '2px solid #5cb85c';
                                    newCell.style.fontWeight = 'bold';
                                }
                                
                                newRow.appendChild(newCell);
                            });
                            
                            newTbody.appendChild(newRow);
                        });
                        
                        newFinalTable.appendChild(newTbody);
                    }
                    
                    // 复制表脚
                    const tfoot = finalTable.querySelector('tfoot');
                    if (tfoot) {
                        const newTfoot = document.createElement('tfoot');
                        const footerRow = tfoot.querySelector('tr');
                        if (footerRow) {
                            const newFooterRow = document.createElement('tr');
                            footerRow.querySelectorAll('td').forEach(cell => {
                                const newCell = document.createElement('td');
                                // 如果单元格有ID，获取对应ID的内容
                                if (cell.id) {
                                    const originalCell = document.getElementById(cell.id);
                                    if (originalCell) {
                                        newCell.textContent = originalCell.textContent;
                                    }
                                } else {
                                    newCell.innerHTML = cell.innerHTML;
                                }
                                
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.backgroundColor = '#f0fff0';
                                newCell.style.fontWeight = 'bold';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.id === 'grandTotal') {
                                    newCell.style.backgroundColor = '#e9f7e9';
                                    newCell.style.borderLeft = '2px solid #5cb85c';
                                }
                                
                                newFooterRow.appendChild(newCell);
                            });
                            
                            newTfoot.appendChild(newFooterRow);
                        }
                        
                        newFinalTable.appendChild(newTfoot);
                    }
                    
                    finalSection.appendChild(newFinalTable);
                    styleContainer.appendChild(finalSection);
                }
                
                // 添加当前订单详情（如果需要）
                if (exportContent === 'current') {
                    const currentOrder = document.querySelector('.order-tab-content.active');
                    const orderId = currentOrder.dataset.orderId;
                    
                    // 创建订单区域
                    const orderSection = document.createElement('div');
                    orderSection.style.marginTop = '20px';
                    
                    // 添加订单标题
                    const orderTitle = document.createElement('h2');
                    orderTitle.style.color = '#4682B4';
                    orderTitle.style.fontSize = '18px';
                    orderTitle.style.marginBottom = '10px';
                    orderTitle.style.borderBottom = '2px solid #4682B4';
                    orderTitle.style.paddingBottom = '5px';
                    orderTitle.textContent = `訂單 ${orderId} 明細`;
                    orderSection.appendChild(orderTitle);
                    
                    // 处理订单表格
                    const orderTables = currentOrder.querySelectorAll('table');
                    orderTables.forEach(table => {
                        const newTable = createFormattedTable(table);
                        orderSection.appendChild(newTable);
                        // 添加一些间距
                        const spacer = document.createElement('div');
                        spacer.style.height = '20px';
                        orderSection.appendChild(spacer);
                    });
                    
                    styleContainer.appendChild(orderSection);
                }
                
                // 添加所有订单详情（如果需要）
                if (exportContent === 'all') {
                    const allOrders = document.querySelectorAll('.order-tab-content');
                    allOrders.forEach(order => {
                        const orderId = order.dataset.orderId;
                        
                        // 创建订单区域
                        const orderSection = document.createElement('div');
                        orderSection.style.marginTop = '20px';
                        orderSection.style.pageBreakBefore = 'always'; // 每个订单从新页开始
                        
                        // 添加订单标题
                        const orderTitle = document.createElement('h2');
                        let titleColor = '#4682B4'; // 默认蓝色
                        // 根据订单ID设置不同颜色
                        if (orderId === '2') titleColor = '#9370DB';
                        else if (orderId === '3') titleColor = '#e67e22';
                        else if (orderId === '4') titleColor = '#16a085';
                        else if (orderId === '5') titleColor = '#c0392b';
                        
                        orderTitle.style.color = titleColor;
                        orderTitle.style.fontSize = '18px';
                        orderTitle.style.marginBottom = '10px';
                        orderTitle.style.borderBottom = `2px solid ${titleColor}`;
                        orderTitle.style.paddingBottom = '5px';
                        orderTitle.textContent = `訂單 ${orderId} 明細`;
                        orderSection.appendChild(orderTitle);
                        
                        // 处理订单表格
                        const orderTables = order.querySelectorAll('table');
                        orderTables.forEach(table => {
                            const newTable = createFormattedTable(table);
                            orderSection.appendChild(newTable);
                            // 添加一些间距
                            const spacer = document.createElement('div');
                            spacer.style.height = '20px';
                            orderSection.appendChild(spacer);
                        });
                        
                        styleContainer.appendChild(orderSection);
                    });
                }
                
                // 添加页脚
                const footer = document.createElement('div');
                footer.style.marginTop = '30px';
                footer.style.textAlign = 'center';
                footer.style.fontSize = '12px';
                footer.style.color = '#888';
                footer.textContent = `CJT體重增加費用分攤計算器 By GaryLEI © ${new Date().getFullYear()}`;
                styleContainer.appendChild(footer);
                
                pdfContent.appendChild(styleContainer);
                
                // 使用html2canvas将内容转换为图片
                html2canvas(styleContainer, {
                    scale: 2, // 提高清晰度
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                }).then(canvas => {
                    // 添加到PDF
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const margin = 10;
                    
                    // 计算图像尺寸以适应页面
                    const imgWidth = pdfWidth - (2 * margin);
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // 添加图像到PDF，如果高度超过页面高度，会自动添加新页
                    pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
                    
                    // 完成PDF
                    loadingIndicator.style.display = 'none';
                    overlay.style.display = 'none';
                    document.body.removeChild(pdfContent);
                    
                    // 下载PDF
                    pdf.save(filename);
                });
                
                // 创建格式化表格的辅助函数
                function createFormattedTable(originalTable) {
                    const newTable = document.createElement('table');
                    newTable.style.width = '100%';
                    newTable.style.borderCollapse = 'collapse';
                    newTable.style.marginBottom = '10px';
                    newTable.style.border = '1px solid #ddd';
                    
                    // 复制表头
                    const thead = originalTable.querySelector('thead');
                    if (thead) {
                        const newThead = document.createElement('thead');
                        thead.querySelectorAll('tr').forEach(row => {
                            const newRow = document.createElement('tr');
                            
                            row.querySelectorAll('th').forEach(cell => {
                                const newCell = document.createElement('th');
                                newCell.textContent = cell.textContent;
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.backgroundColor = '#f7f7f7';
                                newCell.style.fontWeight = 'bold';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.classList.contains('yellow-bg')) {
                                    newCell.style.backgroundColor = '#FFFD9A';
                                } else if (cell.classList.contains('light-blue-bg')) {
                                    newCell.style.backgroundColor = '#B8E2F2';
                                } else if (cell.classList.contains('orange-bg')) {
                                    newCell.style.backgroundColor = '#FFC87C';
                                }
                                
                                newRow.appendChild(newCell);
                            });
                            
                            newThead.appendChild(newRow);
                        });
                        
                        newTable.appendChild(newThead);
                    }
                    
                    // 复制表体
                    const tbody = originalTable.querySelector('tbody');
                    if (tbody) {
                        const newTbody = document.createElement('tbody');
                        
                        tbody.querySelectorAll('tr').forEach((row, rowIndex) => {
                            const newRow = document.createElement('tr');
                            // 设置交替行的背景色
                            if (rowIndex % 2 === 1) {
                                newRow.style.backgroundColor = '#f9f9f9';
                            }
                            
                            row.querySelectorAll('td').forEach(cell => {
                                const newCell = document.createElement('td');
                                
                                // 处理输入框
                                if (cell.querySelector('input')) {
                                    newCell.textContent = cell.querySelector('input').value;
                                } else if (cell.classList.contains('percentage')) {
                                    newCell.textContent = cell.textContent;
                                } else if (cell.classList.contains('net-pay')) {
                                    newCell.textContent = cell.textContent;
                                } else if (cell.querySelector('.remove-btn')) {
                                    // 忽略删除按钮
                                    newCell.textContent = '';
                                } else {
                                    newCell.textContent = cell.textContent;
                                }
                                
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.classList.contains('yellow-bg')) {
                                    newCell.style.backgroundColor = '#FFFD9A';
                                } else if (cell.classList.contains('light-blue-bg')) {
                                    newCell.style.backgroundColor = '#B8E2F2';
                                } else if (cell.classList.contains('orange-bg')) {
                                    newCell.style.backgroundColor = '#FFC87C';
                                }
                                
                                newRow.appendChild(newCell);
                            });
                            
                            newTbody.appendChild(newRow);
                        });
                        
                        newTable.appendChild(newTbody);
                    }
                    
                    // 复制表脚
                    const tfoot = originalTable.querySelector('tfoot');
                    if (tfoot) {
                        const newTfoot = document.createElement('tfoot');
                        
                        tfoot.querySelectorAll('tr').forEach(row => {
                            const newRow = document.createElement('tr');
                            
                            row.querySelectorAll('td').forEach(cell => {
                                const newCell = document.createElement('td');
                                newCell.textContent = cell.textContent;
                                newCell.style.padding = '8px';
                                newCell.style.border = '1px solid #ddd';
                                newCell.style.backgroundColor = '#e9f5ff';
                                newCell.style.fontWeight = 'bold';
                                newCell.style.textAlign = 'center';
                                
                                if (cell.classList.contains('red-text')) {
                                    newCell.style.color = '#e74c3c';
                                }
                                
                                newRow.appendChild(newCell);
                            });
                            
                            newTfoot.appendChild(newRow);
                        });
                        
                        newTable.appendChild(newTfoot);
                    }
                    
                    return newTable;
                }
            }
            
            // 在"总结算表"上添加ID，方便PDF导出
            document.querySelector('.calculator-section:last-child').id = 'finalSummarySection';
            
            // 添加删除订单确认对话框
            let deleteOrderDialog = document.createElement('div');
            deleteOrderDialog.className = 'delete-confirm-dialog';
            deleteOrderDialog.id = 'deleteOrderDialog';
            deleteOrderDialog.innerHTML = `
                <h3>刪除訂單</h3>
                <p>您確定要刪除此訂單嗎？此操作無法恢復，且訂單中的所有數據都將丟失。</p>
                <div class="buttons">
                    <button class="cancel-btn"><i class="fas fa-times"></i> 取消</button>
                    <button class="confirm-btn"><i class="fas fa-trash-alt"></i> 確定刪除</button>
                </div>
            `;
            document.body.appendChild(deleteOrderDialog);
            
            // 显示删除订单确认对话框
            function showDeleteOrderConfirm(orderId) {
                const dialog = document.getElementById('deleteOrderDialog');
                const overlay = document.getElementById('overlay');
                
                if (dialog && overlay) {
                    dialog.style.display = 'block';
                    overlay.style.display = 'block';
                    
                    // 设置确认按钮事件
                    const confirmBtn = dialog.querySelector('.confirm-btn');
                    if (confirmBtn) {
                        // 移除之前可能存在的事件监听器
                        const newConfirmBtn = confirmBtn.cloneNode(true);
                        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                        
                        // 添加新的事件监听器
                        newConfirmBtn.addEventListener('click', function() {
                            deleteOrder(orderId);
                        });
                    }
                    
                    // 设置取消按钮事件
                    const cancelBtn = dialog.querySelector('.cancel-btn');
                    if (cancelBtn) {
                        // 移除之前可能存在的事件监听器
                        const newCancelBtn = cancelBtn.cloneNode(true);
                        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                        
                        // 添加新的事件监听器
                        newCancelBtn.addEventListener('click', hideDeleteOrderConfirm);
                    }
                }
            }
            
            // 隐藏删除订单确认对话框
            function hideDeleteOrderConfirm() {
                const dialog = document.getElementById('deleteOrderDialog');
                if (dialog) {
                    dialog.style.display = 'none';
                }
                
                const overlay = document.getElementById('overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
            
            // 删除订单
            function deleteOrder(orderId) {
                // 1. 删除订单标签
                const orderTab = document.querySelector(`.order-tab[data-order-id="${orderId}"]`);
                if (orderTab) {
                    orderTab.remove();
                }
                
                // 2. 删除订单内容
                const orderContent = document.querySelector(`.order-tab-content[data-order-id="${orderId}"]`);
                if (orderContent) {
                    orderContent.remove();
                }
                
                // 3. 更新订单计数（不减少orderCounter，只是重新排序）
                renumberOrders();
                
                // 4. 如果当前活动的是被删除的订单，切换到订单1
                if (parseInt(activeOrderId) === parseInt(orderId)) {
                    switchTab('1');
                }
                
                // 5. 更新总结算表
                updateFinalSummaryHeaders();
                
                // 6. 清空已刪除訂單的記錄，避免總結算表中包含已刪除的數據
                setTimeout(function() {
                    updateFinalSummary();
                    updateSummarySection(); // 更新摘要区域
                }, 100);
                
                // 7. 关闭确认对话框和遮罩层
                hideDeleteOrderConfirm();
            }
            
            // 重新对订单编号
            function renumberOrders() {
                // 获取所有订单标签和内容
                const orderTabs = document.querySelectorAll('.order-tab');
                const orderContents = document.querySelectorAll('.order-tab-content');
                
                // 从第2个订单开始重新编号（第1个订单保持不变）
                for (let i = 1; i < orderTabs.length; i++) {
                    if (orderTabs[i].id !== 'addOrderTabBtn') {
                        const newOrderId = i + 1;
                        const oldOrderId = orderTabs[i].dataset.orderId;
                        
                        // 更新标签
                        orderTabs[i].textContent = `訂單 ${newOrderId}`;
                        orderTabs[i].dataset.orderId = newOrderId;
                        
                        // 更新删除按钮
                        const deleteBtn = orderTabs[i].querySelector('.order-delete-btn');
                        if (deleteBtn) {
                            deleteBtn.dataset.orderId = newOrderId;
                        }
                        
                        // 如果找到对应的内容区域，更新其ID
                        const content = document.querySelector(`.order-tab-content[data-order-id="${oldOrderId}"]`);
                        if (content) {
                            content.dataset.orderId = newOrderId;
                            
                            // 更新内容区域内的ID和引用
                            const mealTable = content.querySelector('.meal-table');
                            const mealTableBody = content.querySelector('.meal-table-body');
                            const addRowBtn = content.querySelector('.add-row-btn');
                            const expenseTable = content.querySelector('.expense-table');
                            const expenseTableBody = content.querySelector('.expense-table-body');
                            
                            if (mealTable) mealTable.id = `mealTable${newOrderId}`;
                            if (mealTableBody) mealTableBody.id = `mealTableBody${newOrderId}`;
                            if (addRowBtn) addRowBtn.dataset.orderId = newOrderId;
                            if (expenseTable) expenseTable.id = `expenseTable${newOrderId}`;
                            if (expenseTableBody) expenseTableBody.id = `expenseTableBody${newOrderId}`;
                            
                            // 更新表头文本
                            const headers = content.querySelectorAll('.section-header');
                            headers.forEach(header => {
                                header.textContent = header.textContent.replace(/訂單 \d+/g, `訂單 ${newOrderId}`);
                            });
                        }
                        
                        // 更新rowCounters对象
                        rowCounters[newOrderId] = rowCounters[oldOrderId];
                        delete rowCounters[oldOrderId];
                    }
                }
                
                // 更新 rowCounters 对象中的 key，使其与新的订单ID匹配
                const newRowCounters = {};
                for (let i = 1; i <= orderCounter; i++) {
                    newRowCounters[i] = rowCounters[i] || 1;
                }
                rowCounters = newRowCounters;
            }
            
            // 更新总结算表的表头，以反映当前的订单
            function updateFinalSummaryHeaders() {
                // 確保所有訂單的資料都重新計算並更新到總結算表
                for (let i = 1; i <= orderCounter; i++) {
                    // 檢查訂單是否存在
                    if (document.querySelector(`#mealTable${i}`)) {
                        calculateOrderById(i);
                    }
                }
                
                // 更新總結算表，確保刪除訂單後總結算表正確顯示
                updateFinalSummary();
            }
            
            // 常用飯友相關函數
            
            // 從 localStorage 加載常用飯友
            function loadFrequentFriends() {
                const savedFriends = localStorage.getItem('frequentFriends');
                if (savedFriends) {
                    try {
                        frequentFriends = JSON.parse(savedFriends);
                        updateFrequentFriendsUI();
                    } catch (e) {
                        console.error('加載常用飯友時出錯:', e);
                        initDefaultFriendsList();
                    }
                } else {
                    // 初始化默認飯友列表
                    initDefaultFriendsList();
                }
            }
            
            // 初始化默認的飯友列表
            function initDefaultFriendsList() {
                frequentFriends = ['HOU', 'JULIA', 'KAREN', 'BAXTER', '擧', 'GRACE', 'KC', 'A', 'B', 'C', 'D', 'E', 'F', 'G'];
                saveFrequentFriends();
                updateFrequentFriendsUI();
            }
            
            // 保存常用飯友到 localStorage
            function saveFrequentFriends() {
                localStorage.setItem('frequentFriends', JSON.stringify(frequentFriends));
            }
            
            // 更新常用飯友UI顯示
            function updateFrequentFriendsUI() {
                const friendChips = document.getElementById('friendChips');
                friendChips.innerHTML = '';
                
                frequentFriends.forEach((friend, index) => {
                    const chip = document.createElement('div');
                    chip.className = 'friend-chip';
                    chip.innerHTML = `
                        <i class="fas fa-user"></i> ${friend}
                        <span class="remove-friend" data-index="${index}">&times;</span>
                    `;
                    chip.dataset.name = friend;
                    
                    // 點擊飯友名稱添加到當前行
                    chip.addEventListener('click', function(e) {
                        if (!e.target.classList.contains('remove-friend')) {
                            addFriendToRow(friend);
                        }
                    });
                    
                    friendChips.appendChild(chip);
                });
                
                // 為刪除按鈕添加事件
                document.querySelectorAll('.remove-friend').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation(); // 防止觸發父元素的點擊事件
                        const index = parseInt(this.dataset.index);
                        removeFrequentFriend(index);
                    });
                });
                
                // 更新管理對話框中的列表
                updateFriendsTable();
            }
            
            // 添加新的常用飯友
            function addNewFrequentFriend() {
                const nameInput = document.getElementById('newFriendName');
                const name = nameInput.value.trim();
                
                if (name) {
                    if (!frequentFriends.includes(name)) {
                        frequentFriends.push(name);
                        saveFrequentFriends();
                        updateFrequentFriendsUI();
                        nameInput.value = '';
                    } else {
                        alert('此飯友已存在!');
                    }
                }
            }
            
            // 移除常用飯友
            function removeFrequentFriend(index) {
                if (index >= 0 && index < frequentFriends.length) {
                    frequentFriends.splice(index, 1);
                    saveFrequentFriends();
                    updateFrequentFriendsUI();
                }
            }
            
            // 將飯友添加到當前選中的行
            function addFriendToRow(friendName) {
                // 查找當前激活的訂單
                const activeOrder = document.querySelector(`.order-tab-content[data-order-id="${activeOrderId}"]`);
                if (!activeOrder) return;
                
                // 嘗試查找一個空的人名輸入框
                let emptyNameInput = Array.from(activeOrder.querySelectorAll('.person-name')).find(input => !input.value.trim());
                
                if (!emptyNameInput) {
                    // 如果沒有空的輸入框，添加一個新行
                    addNewRow(activeOrderId);
                    // 重新獲取最後添加的行
                    const rows = activeOrder.querySelectorAll('.item-row');
                    emptyNameInput = rows[rows.length - 1].querySelector('.person-name');
                }
                
                if (emptyNameInput) {
                    emptyNameInput.value = friendName;
                    // 觸發計算更新
                    calculateOrderById(activeOrderId);
                    updateFinalSummary();
                }
            }
            
            // 顯示飯友管理對話框
            function showFriendsDialog() {
                updateFriendsTable();
                document.getElementById('friendsDialog').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }
            
            // 隱藏飯友管理對話框
            function hideFriendsDialog() {
                document.getElementById('friendsDialog').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }
            
            // 更新飯友管理表格
            function updateFriendsTable() {
                const tbody = document.getElementById('friendsTableBody');
                tbody.innerHTML = '';
                
                frequentFriends.forEach((friend, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${friend}</td>
                        <td>
                            <button class="delete-friend-btn" data-index="${index}" style="color: #e74c3c; background: none; border: none; cursor: pointer; min-width: auto; padding: 5px; box-shadow: none;">
                                <i class="fas fa-trash-alt"></i> 刪除
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // 為刪除按鈕添加事件
                document.querySelectorAll('.delete-friend-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        removeFrequentFriend(index);
                    });
                });
            }
            
            // 添加新訂單時，將常用飯友功能也加入新訂單
            
            // 設置新訂單的常用飯友功能
            function setupFrequentFriendsFeature(orderId) {
                // 更新訂單的常用飯友UI
                updateOrderFrequentFriendsUI(orderId);
                
                // 添加事件監聽器
                document.getElementById(`manageFriendsBtn${orderId}`).addEventListener('click', showFriendsDialog);
                
                // 添加保存和加載飯友按鈕的事件監聽器
                document.getElementById(`saveFriendsBtn${orderId}`).addEventListener('click', exportFrequentFriends);
                document.getElementById(`loadFriendsBtn${orderId}`).addEventListener('click', importFrequentFriends);
                
                document.getElementById(`addFriendBtn${orderId}`).addEventListener('click', function() {
                    const nameInput = document.getElementById(`newFriendName${orderId}`);
                    const name = nameInput.value.trim();
                    
                    if (name) {
                        if (!frequentFriends.includes(name)) {
                            frequentFriends.push(name);
                            saveFrequentFriends();
                            updateFrequentFriendsUI();
                            nameInput.value = '';
                        } else {
                            alert('此飯友已存在!');
                        }
                    }
                });
                
                document.getElementById(`newFriendName${orderId}`).addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById(`addFriendBtn${orderId}`).click();
                    }
                });
            }
            
            // 更新指定訂單的常用飯友UI
            function updateOrderFrequentFriendsUI(orderId) {
                const friendChips = document.querySelector(`.friend-chips-${orderId}`);
                if (!friendChips) return;
                
                friendChips.innerHTML = '';
                
                frequentFriends.forEach((friend) => {
                    const chip = document.createElement('div');
                    chip.className = 'friend-chip';
                    chip.innerHTML = `<i class="fas fa-user"></i> ${friend}`;
                    chip.dataset.name = friend;
                    
                    // 點擊飯友名稱添加到當前行
                    chip.addEventListener('click', function() {
                        if (orderId === activeOrderId) {
                            addFriendToRow(friend);
                        } else {
                            // 如果點擊的不是當前活動的訂單，先切換到該訂單
                            switchTab(orderId.toString());
                            addFriendToRow(friend);
                        }
                    });
                    
                    friendChips.appendChild(chip);
                });
            }
            
            // 在每次常用飯友列表變更時，更新所有訂單的常用飯友UI
            function updateAllOrdersFrequentFriendsUI() {
                for (let i = 1; i <= orderCounter; i++) {
                    updateOrderFrequentFriendsUI(i);
                }
            }
            
            // 修改updateFrequentFriendsUI函數，使其也更新所有訂單的常用飯友UI
            const originalUpdateFrequentFriendsUI = updateFrequentFriendsUI;
            updateFrequentFriendsUI = function() {
                originalUpdateFrequentFriendsUI();
                updateAllOrdersFrequentFriendsUI();
            };
            
            // 導出常用飯友到文件
            function exportFrequentFriends() {
                if (frequentFriends.length === 0) {
                    alert('沒有飯友可供導出！');
                    return;
                }
                
                const friends = JSON.stringify(frequentFriends);
                const blob = new Blob([friends], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'cjt_frequent_friends.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert('飯友名單已成功導出！');
            }
            
            // 從文件導入常用飯友
            function importFrequentFriends() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                // 將新導入的飯友與現有飯友合併，並去重
                                const mergedFriends = [...new Set([...frequentFriends, ...data])];
                                frequentFriends = mergedFriends;
                                saveFrequentFriends();
                                updateFrequentFriendsUI();
                                alert('成功導入了 ' + data.length + ' 位飯友！');
                            } else {
                                alert('文件格式不正確，請選擇有效的飯友文件。');
                            }
                        } catch (err) {
                            alert('無法讀取文件：' + err.message);
                        }
                    };
                    reader.readAsText(file);
                });
                
                input.click();
            }
            
            // 設置第一個訂單的常用飯友功能
            setupFrequentFriendsFeature(1);
            
            // 自動計算
            calculateAll();
            updateFinalSummary();

            // 初始化膠袋费显示
            document.querySelectorAll('.bag-fee-count').forEach((countDisplay, idx) => {
                const order = parseInt(countDisplay.closest('[id^=expenseTable]').id.replace('expenseTable', '')) || 1;
                const bagInput = document.querySelector(`#expenseTable${order} .bag-fee-total`);
                if (bagInput) {
                    countDisplay.textContent = bagInput.value || '0';
                }
            });

            // 处理商家优惠调整按钮
            document.addEventListener('click', function(e) {
                if (e.target.closest('.discount-decrease')) {
                    const button = e.target.closest('.discount-decrease');
                    const container = button.closest('td');
                    const input = container.querySelector('.merchant-discount');
                    
                    // 添加按钮点击动画效果
                    button.classList.add('clicked');
                    setTimeout(() => button.classList.remove('clicked'), 200);
                    
                    // 获取当前值并减少0.5
                    let currentValue = parseFloat(input.value) || 0;
                    currentValue = Math.max(0, currentValue - 0.5); // 确保不小于0
                    input.value = currentValue.toFixed(2);
                    
                    // 触发计算
                    const order = parseInt(container.closest('[id^=expenseTable]').id.replace('expenseTable', '')) || 1;
                    calculateOrderById(order);
                    updateFinalSummary();
                    
                    // 显示提示信息
                    showMerchantDiscountTooltip(button, '減少商家優惠0.5元');
                }
                
                if (e.target.closest('.discount-increase')) {
                    const button = e.target.closest('.discount-increase');
                    const container = button.closest('td');
                    const input = container.querySelector('.merchant-discount');
                    
                    // 添加按钮点击动画效果
                    button.classList.add('clicked');
                    setTimeout(() => button.classList.remove('clicked'), 200);
                    
                    // 获取当前值并增加0.5
                    let currentValue = parseFloat(input.value) || 0;
                    currentValue += 0.5;
                    input.value = currentValue.toFixed(2);
                    
                    // 触发计算
                    const order = parseInt(container.closest('[id^=expenseTable]').id.replace('expenseTable', '')) || 1;
                    calculateOrderById(order);
                    updateFinalSummary();
                    
                    // 显示提示信息
                    showMerchantDiscountTooltip(button, '增加商家優惠0.5元');
                }
            });
            
            // 显示商家优惠提示框
            function showMerchantDiscountTooltip(button, message) {
                // 移除已有提示框
                const existingTooltips = document.querySelectorAll('.merchant-discount-tooltip');
                existingTooltips.forEach(tip => tip.remove());
                
                // 创建新提示框
                const tooltip = document.createElement('div');
                tooltip.className = 'merchant-discount-tooltip';
                tooltip.textContent = message;
                
                // 获取按钮位置并设置提示框位置
                const buttonRect = button.getBoundingClientRect();
                document.body.appendChild(tooltip);
                
                const tooltipRect = tooltip.getBoundingClientRect();
                tooltip.style.left = `${buttonRect.left + buttonRect.width/2 - tooltipRect.width/2}px`;
                tooltip.style.top = `${buttonRect.top - tooltipRect.height - 10}px`;
                
                // 显示提示框并设置自动隐藏
                setTimeout(() => tooltip.classList.add('show'), 10);
                setTimeout(() => {
                    tooltip.classList.remove('show');
                    setTimeout(() => tooltip.remove(), 300);
                }, 2000);
            }
            
            // Add event listeners to the initial bag buttons
        });
    </script>
</body>
</html>